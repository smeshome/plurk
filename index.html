<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plurk é¢¨æ ¼å›æ‡‰ç‰† - Firebase ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ QR Code ç”Ÿæˆå‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* è‡ªè¨‚ä»¿ Plurk é¢¨æ ¼ (èˆ‡åŸç‰ˆç›¸åŒ) */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #eef2f5;
        }
        .font-theme-title {
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
        }
        #main-title-input {
            background: transparent;
            border: 2px dashed transparent;
            text-align: center;
            outline: none;
            transition: border-color 0.2s;
            color: #333;
        }
        #main-title-input:focus {
            border-color: #ff5a00;
        }
        #wall-container {
            display: flex;
            overflow-x: auto;
            padding: 1.5rem;
            gap: 1.5rem;
            min-height: calc(100vh - 180px);
            align-items: flex-start;
            background-image: url('https://images.plurk.com/6rYRzJbEIqWyR8wei5we.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            transition: background-image 0.5s ease-in-out;
        }
        .section-column {
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-radius: 8px;
            width: 380px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            max-height: 75vh;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .section-column:nth-child(odd) { margin-top: 0; align-self: flex-start; }
        .section-column:nth-child(even) { margin-top: 80px; align-self: flex-start; }
        .section-column:nth-child(3n) { margin-top: 40px; }
        .section-column:nth-child(4n) { margin-top: 120px; }
        .section-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            gap: 0.75rem;
            cursor: pointer;
        }
        .section-title-input {
            width: 100%;
            font-size: 1rem;
            background: transparent;
            border: none;
            outline: none;
            line-height: 1.5;
            resize: none;
            padding: 0;
            overflow-y: hidden;
        }
        .section-title-input:focus { box-shadow: none; }
        .section-posts {
            padding: 0;
            flex-grow: 1;
            overflow-y: auto;
            background-color: #f5f8fa;
            transition: all 0.3s ease;
        }
        .section-column.collapsed .section-posts,
        .section-column.collapsed .section-footer {
            display: none;
        }
        .toggle-btn {
            cursor: pointer;
            user-select: none;
            transition: transform 0.3s ease;
        }
        .section-column.collapsed .toggle-btn { transform: rotate(-90deg); }
        .post-card {
            border: none;
            box-shadow: none;
            margin-bottom: 0;
            border-top: 1px solid #e5e5e5;
            transition: background-color 0.2s ease-in-out;
            display: flex;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background-color: #fff;
        }
        .post-card:first-child { border-top: none; }
        .post-card:hover { background-color: #fafcff; transform: none; box-shadow: none; }
        .preserve-lines { white-space: pre-wrap; }
        .like-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; transition: transform 0.2s ease; padding: 0; }
        .like-btn:hover { transform: scale(1.2); }
        .like-btn.liked { color: #ef4444; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); }
        .modal-content { border: 1px solid #ccc; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .theme-button {
            border: 1px solid #ccc;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: all 0.15s ease-in-out;
            font-weight: bold;
        }
        .theme-button:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .theme-button:active { transform: translateY(0); box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
        .plurk-avatar { width: 48px; height: 48px; border-radius: 5px; background-color: #ff5a00; flex-shrink: 0; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.5rem; }
        .reply-avatar { width: 36px; height: 36px; border-radius: 5px; background-color: #6b7280; flex-shrink: 0; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .plurk-qualifier { background-color: #ff5a00; color: white; padding: 2px 8px; border-radius: 12px; font-weight: bold; font-size: 0.875rem; display: inline-block; }
        
        /* Padlet é¢¨æ ¼æ¨£å¼ */
        body.padlet-style {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* ç•¶wall-containeræœ‰èƒŒæ™¯åœ–æ™‚ï¼Œè¦†è“‹bodyçš„èƒŒæ™¯ */
        body.padlet-style #wall-container[style*="background-image"] {
            background-color: rgba(255,255,255,0.1) !important;
        }
        
        body.padlet-style #wall-container {
            background-color: transparent;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            display: flex;
            flex-direction: row;
            gap: 20px;
            padding: 2rem;
            overflow-x: auto;
            overflow-y: hidden;
            align-items: flex-start;
            min-height: calc(100vh - 180px);
            transition: background-image 0.5s ease-in-out;
        }
        
        body.padlet-style .section-column {
            background: transparent;
            border-radius: 12px;
            border: none;
            box-shadow: none;
            width: 320px;
            min-width: 320px;
            max-width: 320px;
            max-height: calc(100vh - 200px);
            margin-top: 0 !important;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            flex-shrink: 0;
        }
        
        body.padlet-style .section-column:hover {
            transform: none;
            box-shadow: none;
        }
        
        body.padlet-style .section-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            padding: 1.5rem;
            border-bottom: none;
        }
        
        body.padlet-style .section-title-input {
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        body.padlet-style .section-title-input::placeholder {
            color: rgba(255,255,255,0.8);
        }
        
        body.padlet-style .section-posts {
            background: transparent;
            padding: 1rem;
            border-radius: 0 0 12px 12px;
        }
        
        body.padlet-style .post-card {
            background: rgba(248, 249, 255, 0.9);
            backdrop-filter: blur(5px);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 16px;
            padding: 1.25rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: block;
        }
        
        body.padlet-style .post-card:first-child {
            border-top: 1px solid #e2e8f0;
        }
        
        body.padlet-style .post-card:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        body.padlet-style .post-card:last-child {
            margin-bottom: 16px;
        }
        
        body.padlet-style .toggle-btn {
            color: white;
        }
        
        body.padlet-style #main-title-input {
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        body.padlet-style #main-title-input:focus {
            border-color: rgba(255,255,255,0.5);
        }
        
        /* Padleté¢¨æ ¼ä¸‹çš„æ–°å¢å€æ®µæ¨£å¼ */
        body.padlet-style .new-plurk-section {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border: 2px dashed #4facfe;
            border-radius: 12px;
            width: 320px;
            min-width: 320px;
            max-width: 320px;
            flex-shrink: 0;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        
        body.padlet-style .new-plurk-section:hover {
            background: rgba(255,255,255,1);
            border-color: #00f2fe;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        body.padlet-style .new-plurk-section .add-section-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        
        body.padlet-style .new-plurk-section .add-section-btn:hover {
            transform: scale(1.1);
        }
        
        /* Padleté¢¨æ ¼ä¸‹çš„æ–°å¢å›æ‡‰æŒ‰éˆ•æ¨£å¼ */
        body.padlet-style .section-add-post {
            padding: 1rem;
            border-bottom: none;
            background: transparent;
        }
        
        body.padlet-style .section-add-post .add-post-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            width: 100%;
            transition: all 0.2s ease;
        }
        
        body.padlet-style .section-add-post .add-post-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
        }
        
        body.padlet-style .section-footer {
            display: none;
        }
        
        /* Padleté¢¨æ ¼ä¸‹çš„é å°¾æ–‡å­— */
        body.padlet-style footer {
            color: white !important;
        }
        
        body.padlet-style footer a {
            color: #4facfe !important;
        }
        
        body.padlet-style footer a:hover {
            color: #00f2fe !important;
        }
        
        /* Padleté¢¨æ ¼ä¸‹éš±è—plurkç›¸é—œå…ƒç´  */
        body.padlet-style .toggle-btn {
            display: none;
        }
        
        body.padlet-style .plurk-avatar {
            display: none;
        }
        
        body.padlet-style .plurk-qualifier {
            display: none;
        }
        
        body.padlet-style .section-header {
            cursor: default;
            padding: 1.5rem 1.5rem 1rem 1.5rem;
        }
        
        /* éš±è—è€å¸«æ–‡å­— */
        body.padlet-style .section-header .font-bold.text-orange-600 {
            display: none;
        }
        
        /* é‡æ–°ä½ˆå±€æŒ‰éˆ•å€åŸŸ */
        body.padlet-style .section-header .flex.items-center.mb-2 {
            justify-content: flex-end;
            margin-bottom: 0.5rem;
        }
        
        /* å±•é–‹ã€åœ–ç‰‡åˆ‡æ›å’Œåˆªé™¤æŒ‰éˆ•æ¨£å¼èª¿æ•´ */
        body.padlet-style .expand-responses-btn,
        body.padlet-style .image-toggle-btn,
        body.padlet-style .delete-section-btn {
            color: rgba(255,255,255,0.8) !important;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        body.padlet-style .expand-responses-btn:hover,
        body.padlet-style .image-toggle-btn:hover,
        body.padlet-style .delete-section-btn:hover {
            background: rgba(255,255,255,0.2);
            color: white !important;
        }
        
        /* Plurké¢¨æ ¼ä¸‹éš±è—ä¸­é–“çš„æ–°å¢å›æ‡‰æŒ‰éˆ•ï¼Œåªä¿ç•™åº•éƒ¨æŒ‰éˆ• */
        body:not(.padlet-style) .section-add-post {
            display: none;
        }
    </style>
</head>
<body class="p-4 sm:p-6">

    <!-- åŒæ­¥ç‹€æ…‹æç¤º -->
    <div id="sync-status" class="fixed bottom-4 right-4 bg-gray-800 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-lg z-50 opacity-0 transition-opacity duration-300 pointer-events-none">
        è³‡æ–™åŒæ­¥ä¸­...
    </div>

    <!-- å³ä¸Šè§’æŒ‰éˆ•å€ -->
    <div class="fixed top-4 right-4 z-50 flex gap-2">
        <button id="new-wall-btn" class="bg-white border border-gray-300 rounded-full w-10 h-10 text-xl flex items-center justify-center theme-button" title="æ–°å›æ‡‰ç‰†">ğŸ†•</button>
        <button id="style-toggle-btn" class="bg-white border border-gray-300 rounded-full w-10 h-10 text-xl flex items-center justify-center theme-button" title="åˆ‡æ›Padleté¢¨æ ¼">ğŸ›ï¸</button>
        <button id="save-btn" class="bg-white border border-gray-300 rounded-full w-10 h-10 text-xl flex items-center justify-center theme-button" title="é›²ç«¯å­˜æª”">ğŸ’¾</button>
        <button id="open-btn" class="bg-white border border-gray-300 rounded-full w-10 h-10 text-xl flex items-center justify-center theme-button" title="é–‹å•ŸèˆŠæª”">ğŸ“‚</button>
        <button id="export-btn" class="bg-white border border-gray-300 rounded-full w-10 h-10 text-xl flex items-center justify-center theme-button" title="åŒ¯å‡ºè³‡æ–™">ğŸ“¤</button>
        <button id="import-btn" class="bg-white border border-gray-300 rounded-full w-10 h-10 text-xl flex items-center justify-center theme-button" title="åŒ¯å…¥è³‡æ–™">ğŸ“¥</button>
        <button id="download-html-btn" class="bg-white border border-gray-300 rounded-full w-10 h-10 text-xl flex items-center justify-center theme-button" title="ä¸‹è¼‰HTMLå ±å‘Š">ğŸ“‹</button>
        <button id="setting-bg-btn" class="bg-white border border-gray-300 rounded-full w-10 h-10 text-xl flex items-center justify-center theme-button" title="è¨­å®šæ²³é“èƒŒæ™¯">ğŸ¨</button>
        <button id="student-mode-btn" class="bg-white border border-gray-300 rounded-full w-10 h-10 text-xl flex items-center justify-center theme-button" title="å­¸ç”Ÿæ¨¡å¼">ğŸ§‘â€ğŸ“</button>
        <button id="help-btn" class="bg-white border border-gray-300 rounded-full w-10 h-10 text-xl flex items-center justify-center theme-button" title="Firebase è¨­å®šèªªæ˜">â“</button>
    </div>
    
    <!-- é é¢æ¨™é¡Œ -->
    <header class="text-center mb-4 flex-shrink-0">
        <input id="main-title-input" type="text" class="font-theme-title text-4xl sm:text-5xl w-full">

    </header>

    <!-- ç‰†é¢å®¹å™¨ (æ²³é“) -->
    <main id="wall-container"></main>
    
    <!-- æ–°å¢å™—æ–‡è¼¸å…¥å€ -->
    <div id="new-plurk-section" class="p-4 flex-shrink-0 max-w-2xl mx-auto">
        <div class="flex items-center gap-3 mb-3">
            <input id="new-plurk-input" type="text" placeholder="åˆ†äº«ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼äº‹..." class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent">
            <button id="add-section-btn" class="theme-button bg-[#ff5a00] text-white py-2 px-6 rounded-lg font-bold whitespace-nowrap">ç™¼æ–°å™—</button>
        </div>
        <div class="flex items-center gap-3">
            <label class="flex items-center cursor-pointer">
                <input type="radio" name="new-plurk-type" value="text" class="mr-2" checked> ç´”æ–‡å­—
            </label>
            <label class="flex items-center cursor-pointer">
                <input type="radio" name="new-plurk-type" value="text_image" class="mr-2"> æ–‡å­—+åœ–ç‰‡
            </label>
            <div id="new-plurk-upload" class="hidden">
                <input type="file" id="new-plurk-file" class="text-sm" accept="image/*">
            </div>
        </div>
    </div>

    <!-- é å°¾ -->
    <footer class="flex-shrink-0 text-center text-sm text-gray-500 font-bold">
        Made by <a href="https://kentxchang.blogspot.tw/" target="_blank" rel="noopener noreferrer" class="text-orange-600 hover:underline">é˜¿å‰›è€å¸«</a> - Firebase ç‰ˆ
    </footer>

    <!-- å›æ‡‰æ¨¡æ…‹è¦–çª— -->
    <div id="post-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white w-full max-w-lg rounded-lg p-6 relative">
            <button id="close-modal-btn" class="absolute top-2 right-2 bg-gray-200 text-gray-700 w-8 h-8 rounded-full font-bold text-lg">&times;</button>
            <form id="post-form">
                <input type="hidden" id="post-id">
                <input type="hidden" id="section-id">
                <h2 id="modal-title" class="font-theme-title text-2xl text-center mb-4 text-gray-800">æ–°å¢ä¸€å‰‡å›æ‡‰</h2>
                <div>
                    <label for="post-title" class="block font-bold mb-1">æ‚¨çš„æš±ç¨±</label>
                    <input type="text" id="post-title" class="w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mt-4">
                    <label for="post-content" class="block font-bold mb-1">å›æ‡‰å…§å®¹</label>
                    <textarea id="post-content" rows="3" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
                </div>
                <div class="mt-4">
                    <label class="block font-bold mb-2">é¡å‹</label>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                        <label class="flex items-center"><input type="radio" name="post-type" value="text" class="mr-2" checked> æ–‡å­—</label>
                        <label class="flex items-center"><input type="radio" name="post-type" value="image_url" class="mr-2"> åœ–ç‰‡ç¶²å€</label>
                        <label class="flex items-center"><input type="radio" name="post-type" value="image_upload" class="mr-2"> ä¸Šå‚³åœ–ç‰‡</label>
                        <label class="flex items-center"><input type="radio" name="post-type" value="youtube" class="mr-2"> YouTube</label>
                        <label class="flex items-center"><input type="radio" name="post-type" value="link" class="mr-2"> ä¸€èˆ¬ç¶²å€</label>
                        <label class="flex items-center"><input type="radio" name="post-type" value="drawing" class="mr-2"> å¡—é´‰å›æ‡‰</label>
                    </div>
                </div>
                <div id="url-input-container" class="mt-4 hidden">
                    <label for="post-url" id="url-label" class="block font-bold mb-1">ç¶²å€</label>
                    <input type="url" id="post-url" class="w-full p-2 border border-gray-300 rounded-md" placeholder="è«‹è²¼ä¸Šå®Œæ•´çš„ç¶²å€...">
                </div>
                <div id="upload-container" class="mt-4 hidden">
                    <label class="block font-bold mb-1">ä¸Šå‚³ (è‡ªå‹•å£“ç¸®)</label>
                    <div id="drop-zone" class="border-2 border-dashed border-gray-300 p-4 text-center cursor-pointer rounded-md">
                        <p>æ‹–æ›³åœ–ç‰‡åˆ°æ­¤ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                        <input type="file" id="image-upload" class="hidden" accept="image/*">
                        <p id="upload-filename" class="text-sm text-gray-600 mt-1"></p>
                    </div>
                </div>
                <div class="mt-6 text-center">
                    <button type="submit" id="submit-btn" class="theme-button bg-blue-500 hover:bg-blue-600 text-white py-2 px-8 rounded-lg font-bold">é€å‡ºå›æ‡‰</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- åœ–ç‰‡æ”¾å¤§æª¢è¦–å™¨ -->
    <div id="image-viewer" class="modal-backdrop fixed inset-0 z-[60] flex items-center justify-center p-4 hidden">
        <div id="image-container" class="relative overflow-hidden w-full h-full flex items-center justify-center" style="touch-action: none;">
            <img src="" alt="æ”¾å¤§åœ–ç‰‡" class="image-content rounded-lg shadow-2xl transition-transform duration-200 ease-out" style="transform-origin: center center;">
            <button id="close-image-viewer-btn" class="fixed top-4 right-4 bg-black bg-opacity-50 hover:bg-opacity-70 text-white w-12 h-12 rounded-full text-2xl font-bold transition-all duration-200 flex items-center justify-center z-10" title="é—œé–‰åœ–ç‰‡">âŒ</button>
        </div>
    </div>

    <!-- è‡ªè¨‚ç¢ºèªè¦–çª— -->
    <div id="confirm-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white w-full max-w-sm rounded-lg p-6 relative">
            <h3 id="confirm-title" class="text-lg font-bold text-gray-900 mb-4">ç¢ºèªæ“ä½œ</h3>
            <p id="confirm-message" class="text-gray-700 mb-6">æ‚¨ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            <div class="flex justify-end gap-3">
                <button id="confirm-cancel-btn" class="theme-button bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                <button id="confirm-ok-btn" class="theme-button bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- å­¸ç”Ÿæ¨¡å¼è¦–çª— (ç¾åŒ–ç‰ˆ) -->
    <div id="student-mode-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white w-full max-w-md rounded-lg shadow-xl overflow-hidden">
            <div class="bg-orange-500 text-white p-4 flex justify-between items-center">
                <h2 class="font-theme-title text-2xl">å­¸ç”Ÿæ¨¡å¼ç¶²å€</h2>
                <button id="close-student-modal-btn" class="text-2xl font-bold leading-none hover:text-orange-200">&times;</button>
            </div>
            <div class="p-6 flex flex-col items-center gap-4">
                <p class="text-center text-gray-600">è«‹æƒæ QR Code æˆ–è¤‡è£½ä»¥ä¸‹ç¶²å€ï¼Œåˆ†äº«çµ¦å­¸ç”Ÿã€‚</p>
                <div id="qrcode-container" class="p-2 bg-white border rounded-lg"></div>
                <input type="text" id="student-url-input" class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-center" readonly>
                <div class="flex justify-center gap-4 mt-2 w-full">
                    <button id="copy-student-url-btn" class="theme-button bg-blue-500 hover:bg-blue-600 text-white py-2 px-6 rounded-lg flex-1">è¤‡è£½ç¶²å€</button>
                    <button id="open-student-url-btn" class="theme-button bg-green-500 hover:bg-green-600 text-white py-2 px-6 rounded-lg flex-1">é–‹å•Ÿåˆ†é </button>
                </div>
            </div>
        </div>
    </div>

    <!-- èƒŒæ™¯è¨­å®šè¦–çª— -->
    <div id="setting-bg-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white w-full max-w-lg rounded-lg p-6 relative">
            <button id="close-bg-modal-btn" class="absolute top-2 right-2 bg-gray-200 text-gray-700 w-8 h-8 rounded-full font-bold text-lg">&times;</button>
            <h2 class="font-theme-title text-2xl text-center mb-4 text-gray-800">è¨­å®šæ²³é“èƒŒæ™¯</h2>
            <div id="bg-upload-container" class="mt-4">
                <label class="block font-bold mb-1">ä¸Šå‚³æ–°èƒŒæ™¯ (è‡ªå‹•å£“ç¸®)</label>
                <div id="bg-drop-zone" class="border-2 border-dashed border-gray-300 p-6 text-center cursor-pointer rounded-md">
                    <p>æ‹–æ›³åœ–ç‰‡åˆ°æ­¤ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                    <input type="file" id="bg-image-upload" class="hidden" accept="image/*">
                    <p id="bg-upload-filename" class="text-sm text-gray-600 mt-1"></p>
                </div>
            </div>
            <div class="mt-6 text-center flex gap-4 justify-center">
                <button id="submit-bg-btn" class="theme-button bg-orange-500 hover:bg-orange-600 text-white py-2 px-8 rounded-lg font-bold">è¨­å®šèƒŒæ™¯</button>
                <button id="restore-bg-btn" class="theme-button bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg font-bold">æ¢å¾©é è¨­</button>
            </div>
        </div>
    </div>


    <!-- Firebase è¨­å®šèªªæ˜è¦–çª— -->
    <div id="help-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white w-full max-w-4xl rounded-lg p-6 relative h-[90vh] flex flex-col">
            <button id="close-help-modal-btn" class="absolute top-2 right-2 bg-gray-200 text-gray-700 w-8 h-8 rounded-full font-bold text-lg">&times;</button>
            <h2 class="font-theme-title text-2xl text-center mb-4 text-gray-800 flex-shrink-0">é›²ç«¯åŒæ­¥è¨­å®šèªªæ˜ (Firebase)</h2>
            <div class="overflow-y-auto pr-2 text-gray-800">
                <p class="mb-4">è«‹ä¾ç…§ä»¥ä¸‹æ­¥é©Ÿè¨­å®šï¼Œå°‡æ‚¨çš„å›æ‡‰ç‰†è³‡æ–™å„²å­˜åˆ°æ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆï¼Œå¯¦ç¾è·¨è£ç½®å³æ™‚åŒæ­¥ã€‚</p>
                
                <h3 class="font-bold text-lg mb-2 mt-4">æ­¥é©Ÿä¸€ï¼šå»ºç«‹ Firebase å°ˆæ¡ˆ</h3>
                <ol class="list-decimal list-inside space-y-2 mb-4 pl-4">
                    <li>å‰å¾€ <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 hover:underline">Firebase æ§åˆ¶å°</a>ã€‚</li>
                    <li>é»æ“Šã€Œå»ºç«‹å°ˆæ¡ˆã€ï¼Œä¸¦ç‚ºæ‚¨çš„å°ˆæ¡ˆå‘½åï¼ˆä¾‹å¦‚ï¼šmy-plurk-wallï¼‰ã€‚</li>
                    <li>ä¾ç…§ç•«é¢æŒ‡ç¤ºå®Œæˆå°ˆæ¡ˆå»ºç«‹ï¼Œæ‚¨å¯ä»¥é¸æ“‡æ€§åœ°å•Ÿç”¨ Google Analyticsã€‚</li>
                </ol>

                <h3 class="font-bold text-lg mb-2 mt-4">æ­¥é©ŸäºŒï¼šè¨­å®š Firestore è³‡æ–™åº«</h3>
                <ol class="list-decimal list-inside space-y-2 mb-4 pl-4">
                    <li>åœ¨å·¦å´é¸å–®ä¸­ï¼Œé»æ“Šã€Œå»ºæ§‹ã€ > ã€ŒAuthentication (èªè­‰)ã€: é»æ“Šã€Œé–‹å§‹ä½¿ç”¨ã€ -> é¸æ“‡ã€ŒåŒ¿åã€ -> å•Ÿç”¨ä¸¦å„²å­˜ã€‚</li>
                    <li>åœ¨å·¦å´é¸å–®ä¸­ï¼Œé»æ“Šã€Œå»ºæ§‹ã€ > ã€ŒFirestore Databaseã€ã€‚</li>
                    <li>é»æ“Šã€Œå»ºç«‹è³‡æ–™åº«ã€ã€‚</li>
                    <li>é¸æ“‡ã€Œä»¥**æ¸¬è©¦æ¨¡å¼**é–‹å§‹ã€ã€‚é€™æœƒè®“è³‡æ–™åº«åœ¨åˆæœŸå¯ä»¥è¢«å…¬é–‹å­˜å–ï¼Œæ–¹ä¾¿æˆ‘å€‘æ¸¬è©¦ã€‚<strong>ï¼ˆé‡è¦ï¼šæ¸¬è©¦æ¨¡å¼çš„å­˜å–æ¬Šé™æœƒåœ¨ 30 å¤©å¾Œåˆ°æœŸï¼‰</strong></li>
                    <li>é¸æ“‡é›¢æ‚¨æœ€è¿‘çš„ Cloud Firestore ä½ç½®ï¼Œç„¶å¾Œé»æ“Šã€Œå•Ÿç”¨ã€ã€‚</li>
                </ol>
                
                <div class="p-4 bg-red-100 border-l-4 border-red-500 text-red-700 my-4 rounded-md">
                    <p class="font-bold">åœ–ç‰‡ä¸Šå‚³æ³¨æ„</p>
                    <p class="mt-1">æœ¬ç¨‹å¼æœƒå°‡åœ–ç‰‡å£“ç¸®å¾Œä»¥æ–‡å­—å½¢å¼å­˜å…¥è³‡æ–™åº«ï¼Œä»¥ç¬¦åˆå…è²»æ–¹æ¡ˆã€‚ä½† Firestore å°å–®ç­†è³‡æ–™æœ‰ 1MB çš„å¤§å°é™åˆ¶ï¼Œè‹¥æ‚¨ä¸Šå‚³çš„åŸå§‹åœ–ç‰‡æª”æ¡ˆéå¤§ï¼ˆä¾‹å¦‚è¶…é 5MB çš„ç…§ç‰‡ï¼‰ï¼Œä»å¯èƒ½å„²å­˜å¤±æ•—ã€‚è‹¥é‡åˆ°æ­¤ç‹€æ³ï¼Œè«‹å˜—è©¦ä½¿ç”¨å°ºå¯¸è¼ƒå°çš„åœ–ç‰‡ã€‚</p>
                </div>

                <h3 class="font-bold text-lg mb-2 mt-4">æ­¥é©Ÿä¸‰ï¼šè¨­å®šæ°¸ä¹…å­˜å–è¦å‰‡ (é‡è¦ï¼)</h3>
                <p class="mb-2">æ¸¬è©¦æ¨¡å¼æœƒåœ¨ 30 å¤©å¾Œå¤±æ•ˆï¼Œç‚ºäº†è®“å›æ‡‰ç‰†æ°¸ä¹…å¯ç”¨ï¼Œè«‹æ‰‹å‹•æ›´æ–°å®‰å…¨è¦å‰‡ï¼š</p>
                <ol class="list-decimal list-inside space-y-2 mb-4 pl-4">
                    <li>
                        <strong>Firestore è¦å‰‡</strong>:
                        <ul class="list-disc list-inside ml-4 mt-1">
                            <li>å›åˆ°ã€ŒFirestore Databaseã€åˆ†é ï¼Œé»æ“Šä¸Šæ–¹çš„ã€Œè¦å‰‡ã€åˆ†é ã€‚</li>
                            <li>å°‡ç·¨è¼¯å™¨ä¸­çš„å…§å®¹å…¨éƒ¨å–ä»£ç‚ºä»¥ä¸‹ç¨‹å¼ç¢¼ï¼Œç„¶å¾Œé»æ“Šã€Œç™¼å¸ƒã€ã€‚</li>
                        </ul>
                        <pre class="bg-gray-100 p-3 rounded-md text-sm overflow-x-auto my-2"><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}</code></pre>
                    </li>
                </ol>
                 <div class="p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 my-4 rounded-md">
                    <p class="font-bold">å®‰å…¨æ€§è­¦å‘Š</p>
                    <p class="mt-1">æ­¤è¦å‰‡å…è¨±ä»»ä½•äººè®€å–å’Œå¯«å…¥æ‚¨çš„è³‡æ–™åº«ã€‚é€™å°æ–¼æ­¤å…¬é–‹å›æ‡‰ç‰†æ˜¯å¿…è¦çš„ï¼Œä½†è«‹å‹¿å°‡ä»»ä½•ç§äººæˆ–æ•æ„Ÿè³‡æ–™å­˜æ”¾åœ¨æ­¤å°ˆæ¡ˆä¸­ã€‚</p>
                </div>

                <h3 class="font-bold text-lg mb-2 mt-6">æ­¥é©Ÿå››ï¼šå–å¾— Firebase è¨­å®šç¢¼ä¸¦è²¼å›æœ¬ç¶²é </h3>
                <ol class="list-decimal list-inside space-y-2 mb-4 pl-4">
                    <li>é»æ“Šå·¦ä¸Šè§’çš„å°ˆæ¡ˆåç¨±æ—é‚Šçš„é½’è¼ªåœ–ç¤ºï¼Œé¸æ“‡ã€Œå°ˆæ¡ˆè¨­å®šã€ã€‚</li>
                    <li>åœ¨ã€Œæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ã€å€å¡Šï¼Œé»æ“Šã€Œ</>ã€ (ç¶²é ) åœ–ç¤ºä¾†è¨»å†Šæ‚¨çš„ç¶²é æ‡‰ç”¨ç¨‹å¼ã€‚</li>
                    <li>ç‚ºæ‚¨çš„æ‡‰ç”¨ç¨‹å¼å–ä¸€å€‹æš±ç¨±ï¼Œç„¶å¾Œé»æ“Šã€Œè¨»å†Šæ‡‰ç”¨ç¨‹å¼ã€ã€‚</li>
                    <li>è¨»å†Šå¾Œï¼ŒFirebase æœƒé¡¯ç¤ºä¸€å€‹ `firebaseConfig` ç‰©ä»¶ã€‚<strong>è«‹é»æ“Šè¤‡è£½åœ–ç¤ºï¼Œå°‡é€™æ®µå®Œæ•´çš„ç¨‹å¼ç¢¼è¤‡è£½ä¸‹ä¾†ã€‚</strong></li>
                    <li>å›åˆ°é€™å€‹å›æ‡‰ç‰†ç¶²é ï¼Œç”¨æ–‡å­—ç·¨è¼¯å™¨æ‰“é–‹æ­¤ HTML æª”æ¡ˆã€‚</li>
                    <li>åœ¨ç¨‹å¼ç¢¼ä¸­æ‰¾åˆ° <code>&lt;script type="module"&gt;</code> å€å¡Šã€‚</li>
                    <li>æ‰¾åˆ°æ¨™ç¤ºç‚ºã€Œè«‹å°‡æ‚¨å¾ Firebase è¤‡è£½çš„è¨­å®šè²¼åœ¨é€™è£¡ã€çš„å€å¡Šï¼Œç”¨æ‚¨å‰›å‰›è¤‡è£½çš„ `firebaseConfig` ç‰©ä»¶ï¼Œå–ä»£æ‰åŸæœ¬çš„ç¯„ä¾‹å…§å®¹ã€‚</li>
                </ol>
                <pre class="bg-gray-100 p-3 rounded-md text-sm overflow-x-auto my-2"><code>
// â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ è«‹å°‡æ‚¨å¾ Firebase è¤‡è£½çš„è¨­å®šè²¼åœ¨é€™è£¡ â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
const firebaseConfig = {
  apiKey: "AIzaSyAJY0S4J7kfdrcwSLplDguvwcjNKSpWNwY",
  authDomain: "classtools-5987d.firebaseapp.com",
  projectId: "classtools-5987d",
  storageBucket: "classtools-5987d.firebasestorage.app",
  messagingSenderId: "569720834005",
  appId: "1:569720834005:web:deb514eb5f9e2344821f5c"
};
// â–²â–²â–²â–²â–²â–²â–²â–²â–² è«‹å°‡æ‚¨å¾ Firebase è¤‡è£½çš„è¨­å®šè²¼åœ¨é€™è£¡ â–²â–²â–²â–²â–²â–²â–²â–²â–²
                </code></pre>
                <p class="mt-2 p-3 bg-green-100 border-l-4 border-green-500 text-green-700 rounded-md">
                    <strong>å®Œæˆï¼</strong> å„²å­˜ HTML æª”æ¡ˆå¾Œï¼Œé‡æ–°ç”¨ç€è¦½å™¨æ‰“é–‹å®ƒã€‚ç¾åœ¨æ‰€æœ‰çš„è³‡æ–™éƒ½æœƒé€éæ‚¨è¨­å®šçš„ Firebase å°ˆæ¡ˆé€²è¡Œå³æ™‚åŒæ­¥äº†ï¼
                </p>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šè‡ªè¨‚è¨Šæ¯è¦–çª— -->
    <div id="alert-modal" class="modal-backdrop fixed inset-0 z-[60] flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white w-full max-w-sm rounded-lg p-6 relative">
            <h3 id="alert-title" class="text-lg font-bold text-gray-900 mb-4">ç³»çµ±è¨Šæ¯</h3>
            <p id="alert-message" class="text-gray-700 mb-6 whitespace-pre-wrap">è¨Šæ¯å…§å®¹</p>
            <div class="flex justify-end gap-3">
                <button id="alert-ok-btn" class="theme-button bg-blue-500 hover:bg-blue-600 text-white py-2 px-6 rounded-lg">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šé–‹å•ŸèˆŠæª”è¦–çª— -->
    <div id="open-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white w-full max-w-2xl rounded-lg p-6 relative h-[70vh] flex flex-col">
            <button id="close-open-modal-btn" class="absolute top-2 right-2 bg-gray-200 text-gray-700 w-8 h-8 rounded-full font-bold text-lg">&times;</button>
            <h2 class="font-theme-title text-2xl text-center mb-4 text-gray-800 flex-shrink-0">é–‹å•ŸèˆŠæª”</h2>
            <div id="archive-list-container" class="overflow-y-auto pr-2 text-gray-800 flex-grow">
                <!-- å­˜æª”åˆ—è¡¨å°‡æœƒå‹•æ…‹æ’å…¥æ­¤è™• -->
            </div>
        </div>
    </div>

    <!-- å¡—é´‰ç•«æ¿è¦–çª— -->
    <div id="drawing-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white w-[95vw] h-[95vh] rounded-lg p-4 relative flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-theme-title text-2xl text-gray-800">å¡—é´‰å›æ‡‰</h2>
                <button id="close-drawing-btn" class="bg-gray-200 text-gray-700 w-10 h-10 rounded-full font-bold text-lg">&times;</button>
            </div>
            
            <div class="flex justify-between items-center gap-4 mb-4">
                <!-- å·¥å…·åˆ— -->
                <div class="flex flex-wrap gap-2 items-center">
                    <button id="brush-tool" class="tool-btn bg-blue-500 text-white px-3 py-1 rounded font-bold">ç•«ç­†</button>
                    <button id="eraser-tool" class="tool-btn bg-gray-500 text-white px-3 py-1 rounded">æ“¦å¸ƒ</button>
                    
                    <div class="flex items-center gap-2 ml-4">
                        <label class="font-bold">ç²—ç´°:</label>
                        <input type="range" id="brush-size" min="1" max="20" value="5" class="w-20">
                        <span id="brush-size-display" class="text-sm">5</span>
                    </div>
                    
                    <div class="flex gap-1 ml-4">
                        <button class="color-btn w-8 h-8 rounded border-2 border-gray-300" data-color="#FF0000" style="background-color: #FF0000" title="ç´…è‰²"></button>
                        <button class="color-btn w-8 h-8 rounded border-2 border-gray-300" data-color="#0000FF" style="background-color: #0000FF" title="è—è‰²"></button>
                        <button class="color-btn w-8 h-8 rounded border-2 border-gray-300" data-color="#00FF00" style="background-color: #00FF00" title="ç¶ è‰²"></button>
                        <button class="color-btn w-8 h-8 rounded border-2 border-gray-300" data-color="#FFFF00" style="background-color: #FFFF00" title="é»ƒè‰²"></button>
                        <button class="color-btn w-8 h-8 rounded border-2 border-gray-300 border-black" data-color="#FFFFFF" style="background-color: #FFFFFF" title="ç™½è‰²"></button>
                        <button class="color-btn w-8 h-8 rounded border-2 border-gray-300" data-color="#000000" style="background-color: #000000" title="é»‘è‰²"></button>
                    </div>
                    
                    <div class="flex gap-2 ml-4">
                        <button id="upload-bg-btn" class="tool-btn bg-green-500 text-white px-3 py-1 rounded">ä¸Šå‚³èƒŒæ™¯</button>
                        <button id="clear-canvas-btn" class="tool-btn bg-red-500 text-white px-3 py-1 rounded">æ¸…ç©º</button>
                    </div>
                </div>
                <button id="save-drawing-btn" class="theme-button bg-blue-500 text-white py-2 px-6 rounded-lg font-bold">å„²å­˜å¡—é´‰</button>
            </div>
            
            <div class="flex-grow relative border border-gray-300 rounded overflow-hidden">
                <canvas id="drawing-bg-canvas" class="absolute inset-0 w-full h-full"></canvas>
                <canvas id="drawing-canvas" class="absolute inset-0 w-full h-full" style="touch-action: none;"></canvas>
            </div>
            
            <input type="file" id="drawing-bg-upload" class="hidden" accept="image/*">
        </div>
    </div>

    <!-- æ–°å¢ï¼šåŒ¯å…¥æª”æ¡ˆè¦–çª— -->
    <div id="import-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white w-full max-w-md rounded-lg p-6 relative">
            <button id="close-import-modal-btn" class="absolute top-2 right-2 bg-gray-200 text-gray-700 w-8 h-8 rounded-full font-bold text-lg">&times;</button>
            <h2 class="font-theme-title text-2xl text-center mb-4 text-gray-800">åŒ¯å…¥è³‡æ–™</h2>
            <div id="import-drop-zone" class="border-2 border-dashed border-gray-300 p-6 text-center cursor-pointer rounded-md mb-4">
                <p>æ‹–æ›³æª”æ¡ˆåˆ°æ­¤ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                <p class="text-sm text-gray-500 mt-2">æ”¯æ´ JSON æ ¼å¼</p>
                <input type="file" id="import-file-input" class="hidden" accept=".json">
            </div>
            <div class="text-center text-gray-500">
                <p>é¸æ“‡æª”æ¡ˆå¾Œå°‡è‡ªå‹•é€²å…¥åŒ¯å…¥ç¢ºèªæµç¨‹</p>
            </div>
        </div>
    </div>

    <!-- å±•é–‹å›æ‡‰è¦–çª— -->
    <div id="responses-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white w-[80vw] h-[90vh] rounded-lg p-6 relative flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="responses-modal-title" class="font-theme-title text-2xl text-gray-800">æ‰€æœ‰å›æ‡‰</h2>
                <button id="close-responses-btn" class="bg-gray-200 text-gray-700 w-10 h-10 rounded-full font-bold text-lg">&times;</button>
            </div>
            
            <!-- å›æ‡‰å…§å®¹å€åŸŸ -->
            <div class="flex-grow overflow-y-auto">
                <div id="responses-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- å›æ‡‰åˆ—è¡¨å°‡å‹•æ…‹æ’å…¥æ­¤è™• -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // åŒ¯å…¥ Firebase æ¨¡çµ„
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, 
            query, orderBy, where, onSnapshot, serverTimestamp, increment, writeBatch
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // ===================================================================================
        // ==  Firebase è¨­å®š
        // ===================================================================================
        // vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
        // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ ä¸­æ–‡å‚™è¨»ï¼šè«‹å°‡æ‚¨å¾ Firebase å°ˆæ¡ˆè¨­å®šä¸­è¤‡è£½çš„ firebaseConfig ç‰©ä»¶ï¼Œå®Œæ•´è²¼åœ¨ä¸‹æ–¹å–ä»£åŸæœ‰çš„å…§å®¹ã€‚ â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
        const firebaseConfig = {
    apiKey: "AIzaSyAJY0S4J7kfdrcwSLplDguvwcjNKSpWNwY",
  authDomain: "classtools-5987d.firebaseapp.com",
  projectId: "classtools-5987d",
  storageBucket: "classtools-5987d.firebasestorage.app",
  messagingSenderId: "569720834005",
  appId: "1:569720834005:web:deb514eb5f9e2344821f5c"
        };
        // â–²â–²â–²â–²â–²â–²â–²â–²â–² ä¸­æ–‡å‚™è¨»ï¼šè«‹å°‡æ‚¨å¾ Firebase å°ˆæ¡ˆè¨­å®šä¸­è¤‡è£½çš„ firebaseConfig ç‰©ä»¶ï¼Œå®Œæ•´è²¼åœ¨ä¸Šæ–¹å–ä»£åŸæœ‰çš„å…§å®¹ã€‚ â–²â–²â–²â–²â–²â–²â–²â–²â–²
        // ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        // ===================================================================================

        // DOM å…ƒç´ 
        const mainTitleInput = document.getElementById('main-title-input');
        const newPlurkSection = document.getElementById('new-plurk-section');
        const newPlurkInput = document.getElementById('new-plurk-input');
        const addSectionBtn = document.getElementById('add-section-btn');
        const wallContainer = document.getElementById('wall-container');
        const postModal = document.getElementById('post-modal');
        const postForm = document.getElementById('post-form');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const submitBtn = document.getElementById('submit-btn');
        const helpBtn = document.getElementById('help-btn');
        const studentModeBtn = document.getElementById('student-mode-btn');
        const settingBgBtn = document.getElementById('setting-bg-btn');
        const helpModal = document.getElementById('help-modal');
        const closeHelpModalBtn = document.getElementById('close-help-modal-btn');
        const studentModeModal = document.getElementById('student-mode-modal');
        const closeStudentModalBtn = document.getElementById('close-student-modal-btn');
        const studentUrlInput = document.getElementById('student-url-input');
        const copyStudentUrlBtn = document.getElementById('copy-student-url-btn');
        const openStudentUrlBtn = document.getElementById('open-student-url-btn');
        const settingBgModal = document.getElementById('setting-bg-modal');
        const closeBgModalBtn = document.getElementById('close-bg-modal-btn');
        const bgDropZone = document.getElementById('bg-drop-zone');
        const bgImageUpload = document.getElementById('bg-image-upload');
        const submitBgBtn = document.getElementById('submit-bg-btn');
        const restoreBgBtn = document.getElementById('restore-bg-btn');
        const imageViewer = document.getElementById('image-viewer');
        const dropZone = document.getElementById('drop-zone');
        const imageUpload = document.getElementById('image-upload');
        const syncStatus = document.getElementById('sync-status');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMsg = document.getElementById('confirm-message');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const alertModal = document.getElementById('alert-modal');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const alertOkBtn = document.getElementById('alert-ok-btn');
        const newWallBtn = document.getElementById('new-wall-btn');
        const styleToggleBtn = document.getElementById('style-toggle-btn');
        const saveBtn = document.getElementById('save-btn');
        const openBtn = document.getElementById('open-btn');
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const downloadHtmlBtn = document.getElementById('download-html-btn');
        const openModalEl = document.getElementById('open-modal');
        const closeOpenModalBtn = document.getElementById('close-open-modal-btn');
        const archiveListContainer = document.getElementById('archive-list-container');
        const importModal = document.getElementById('import-modal');
        const closeImportModalBtn = document.getElementById('close-import-modal-btn');
        const importDropZone = document.getElementById('import-drop-zone');
        const importFileInput = document.getElementById('import-file-input');
        
        // å¡—é´‰ç›¸é—œå…ƒç´ 
        const drawingModal = document.getElementById('drawing-modal');
        const closeDrawingBtn = document.getElementById('close-drawing-btn');
        const drawingCanvas = document.getElementById('drawing-canvas');
        const drawingBgCanvas = document.getElementById('drawing-bg-canvas');
        const brushTool = document.getElementById('brush-tool');
        const eraserTool = document.getElementById('eraser-tool');
        const brushSize = document.getElementById('brush-size');
        const brushSizeDisplay = document.getElementById('brush-size-display');
        const colorBtns = document.querySelectorAll('.color-btn');
        const uploadBgBtn = document.getElementById('upload-bg-btn');
        const clearCanvasBtn = document.getElementById('clear-canvas-btn');
        const saveDrawingBtn = document.getElementById('save-drawing-btn');
        const drawingBgUpload = document.getElementById('drawing-bg-upload');
        
        // å±•é–‹å›æ‡‰ç›¸é—œå…ƒç´ 
        const responsesModal = document.getElementById('responses-modal');
        const closeResponsesBtn = document.getElementById('close-responses-btn');
        const responsesModalTitle = document.getElementById('responses-modal-title');
        const responsesContainer = document.getElementById('responses-container');


        // å…¨åŸŸè®Šæ•¸
        let db, auth;
        let sections = [];
        let likedPosts = new Set();
        let syncStatusTimer = null;
        let confirmCallback = null;
        const urlParams = new URLSearchParams(window.location.search);
        const isStudentMode = urlParams.get('mode') === 'student';
        const dataParam = urlParams.get('data');
        let isPadletStyle = localStorage.getItem('isPadletStyle') === 'true';
        let uploadedImageData = null; 
        let uploadedBgImageData = null; 
        let unsubscribeSettings = null; 
        let unsubscribeSections = null; 
        let postUnsubscribers = {}; 
        let unsubscribeArchives = null;
        let importData = null;

        // ç”Ÿæˆéš¨æ©Ÿ4ç¢¼è‹±æ•¸çµ„åˆ
        function generateRandomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 4; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // æª¢æŸ¥ä»£ç¢¼æ˜¯å¦å·²å­˜åœ¨
        async function isCodeExists(code) {
            try {
                const q = query(collection(db, "archives"), where("dataCode", "==", code));
                const snapshot = await getDocs(q);
                return !snapshot.empty;
            } catch (error) {
                console.error("æª¢æŸ¥ä»£ç¢¼å¤±æ•—:", error);
                return false;
            }
        }

        // ç”Ÿæˆå”¯ä¸€çš„éš¨æ©Ÿä»£ç¢¼
        async function generateUniqueCode() {
            let code;
            let attempts = 0;
            const maxAttempts = 100;
            
            do {
                code = generateRandomCode();
                attempts++;
                if (attempts > maxAttempts) {
                    throw new Error("ç„¡æ³•ç”Ÿæˆå”¯ä¸€ä»£ç¢¼ï¼Œè«‹ç¨å¾Œå†è©¦");
                }
            } while (await isCodeExists(code));
            
            return code;
        }

        // æ ¹æ“šä»£ç¢¼è¼‰å…¥è³‡æ–™
        async function loadDataByCode(code) {
            try {
                const q = query(collection(db, "archives"), where("dataCode", "==", code));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    showAlert(`æ‰¾ä¸åˆ°ä»£ç¢¼ç‚º ${code} çš„è³‡æ–™ï¼`, "éŒ¯èª¤");
                    return false;
                }
                
                const archiveDoc = snapshot.docs[0];
                const archiveData = archiveDoc.data();
                
                // æ¸…ç©ºç›®å‰çš„ sections
                const sectionsSnapshot = await getDocs(collection(db, "sections"));
                const deleteBatch = writeBatch(db);
                for (const sectionDoc of sectionsSnapshot.docs) {
                    const postsSnapshot = await getDocs(collection(db, `sections/${sectionDoc.id}/posts`));
                    postsSnapshot.forEach(postDoc => deleteBatch.delete(postDoc.ref));
                    deleteBatch.delete(sectionDoc.ref);
                }
                await deleteBatch.commit();

                // å¯«å…¥æ–°è³‡æ–™
                const addBatch = writeBatch(db);
                // å¯«å…¥è¨­å®š
                const settingsRef = doc(db, "settings", "config");
                addBatch.set(settingsRef, {
                    mainTitle: archiveData.title,
                    backgroundUrl: archiveData.backgroundUrl
                });

                // å¯«å…¥ sections å’Œ posts
                archiveData.sections.forEach((section, index) => {
                    const sectionRef = doc(collection(db, "sections"));
                    const sectionData = {
                        title: section.title,
                        createdAt: new Date(section.createdAt),
                        order: index
                    };
                    addBatch.set(sectionRef, sectionData);

                    section.posts.forEach((post, postIndex) => {
                        const postRef = doc(collection(db, `sections/${sectionRef.id}/posts`));
                        const postData = {
                            ...post,
                            createdAt: new Date(post.createdAt),
                            order: postIndex
                        };
                        addBatch.set(postRef, postData);
                    });
                });

                await addBatch.commit();
                return true;
            } catch (error) {
                console.error("è¼‰å…¥è³‡æ–™å¤±æ•—:", error);
                showAlert(`è¼‰å…¥è³‡æ–™å¤±æ•—ï¼\n${error.message}`, "éŒ¯èª¤");
                return false;
            }
        }

        // ç‚ºæ²’æœ‰ä»£ç¢¼çš„èˆŠå­˜æª”åˆ†é…éš¨æ©Ÿä»£ç¢¼
        async function assignCodesForOldArchives() {
            try {
                const q = query(collection(db, "archives"));
                const snapshot = await getDocs(q);
                
                const updatePromises = [];
                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    if (!data.dataCode) {
                        const newCode = await generateUniqueCode();
                        updatePromises.push(
                            updateDoc(doc.ref, { dataCode: newCode })
                        );
                    }
                }
                
                if (updatePromises.length > 0) {
                    await Promise.all(updatePromises);
                    console.log(`å·²ç‚º ${updatePromises.length} å€‹èˆŠå­˜æª”åˆ†é…ä»£ç¢¼`);
                }
            } catch (error) {
                console.error("åˆ†é…ä»£ç¢¼å¤±æ•—:", error);
            }
        }

        // æ–°å›æ‡‰ç‰†åŠŸèƒ½
        const createNewWall = async () => {
            if (!checkFirebase()) return;
            
            showConfirm('ç¢ºå®šè¦æ¸…ç©ºç•¶å‰å›æ‡‰ç‰†ä¸¦å»ºç«‹æ–°çš„å›æ‡‰ç‰†å—ï¼Ÿæ­¤æ“ä½œæœƒæ°¸ä¹…åˆªé™¤æ‰€æœ‰ç¾æœ‰å…§å®¹ã€‚', async () => {
                try {
                    showSyncStatus(true, false, 'æ¸…ç©ºå›æ‡‰ç‰†ä¸­...');
                    
                    // æ¸…ç©ºæ‰€æœ‰ sections å’Œ posts
                    const sectionsSnapshot = await getDocs(collection(db, "sections"));
                    const deleteBatch = writeBatch(db);
                    
                    for (const sectionDoc of sectionsSnapshot.docs) {
                        const postsSnapshot = await getDocs(collection(db, `sections/${sectionDoc.id}/posts`));
                        postsSnapshot.forEach(postDoc => deleteBatch.delete(postDoc.ref));
                        deleteBatch.delete(sectionDoc.ref);
                    }
                    
                    await deleteBatch.commit();
                    
                    // é‡è¨­ä¸»æ¨™é¡Œ
                    await setDoc(doc(db, "settings", "config"), { 
                        mainTitle: "Plurk é¢¨æ ¼å›æ‡‰ç‰† - Firebase ç‰ˆ",
                        backgroundUrl: "https://images.plurk.com/6rYRzJbEIqWyR8wei5we.jpg"
                    }, { merge: true });
                    
                    showSyncStatus(false, false, 'æ–°å›æ‡‰ç‰†å·²å»ºç«‹ï¼');
                    showAlert('æ–°å›æ‡‰ç‰†å·²å»ºç«‹ï¼');
                    
                } catch (error) {
                    console.error("å»ºç«‹æ–°å›æ‡‰ç‰†å¤±æ•—:", error);
                    showAlert(`å»ºç«‹æ–°å›æ‡‰ç‰†å¤±æ•—ï¼\n${error.message}`, "éŒ¯èª¤");
                    showSyncStatus(false, true);
                }
            });
        };

        // é¢¨æ ¼åˆ‡æ›åŠŸèƒ½
        const toggleStyle = () => {
            isPadletStyle = !isPadletStyle;
            localStorage.setItem('isPadletStyle', isPadletStyle.toString());
            applyStyle();
            updateStyleButton();
            updateUIText();
            renderApp(); // é‡æ–°æ¸²æŸ“ä»¥æ‡‰ç”¨æ–°çš„æ’åº
        };

        // æ‡‰ç”¨ç•¶å‰é¢¨æ ¼
        const applyStyle = () => {
            if (isPadletStyle) {
                document.body.classList.add('padlet-style');
            } else {
                document.body.classList.remove('padlet-style');
            }
        };

        // æ›´æ–°é¢¨æ ¼æŒ‰éˆ•é¡¯ç¤º
        const updateStyleButton = () => {
            if (isPadletStyle) {
                styleToggleBtn.textContent = 'ğŸ“‹';
                styleToggleBtn.title = 'åˆ‡æ›Plurké¢¨æ ¼';
            } else {
                styleToggleBtn.textContent = 'ğŸ›ï¸';
                styleToggleBtn.title = 'åˆ‡æ›Padleté¢¨æ ¼';
            }
        };

        // æ›´æ–°UIæ–‡å­—æ ¹æ“šé¢¨æ ¼
        const updateUIText = () => {
            const addSectionBtn = document.getElementById('add-section-btn');
            const newPlurkInput = document.getElementById('new-plurk-input');
            
            if (isPadletStyle) {
                addSectionBtn.textContent = 'æ–°å¢å€æ®µ';
                newPlurkInput.placeholder = 'è¼¸å…¥å€æ®µä¸»é¡Œ...';
            } else {
                addSectionBtn.textContent = 'ç™¼æ–°å™—';
                newPlurkInput.placeholder = 'åˆ†äº«ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼äº‹...';
            }
        };

        let newPlurkUploadedImage = null;
        
        // å¡—é´‰ç›¸é—œè®Šæ•¸
        let drawingCtx = null;
        let drawingBgCtx = null;
        let isDrawing = false;
        let currentTool = 'brush';
        let currentColor = '#000000';
        let currentBrushSize = 5;
        let drawingData = null;
        let originalPostImages = [];
        let currentSectionId = null;
        let currentPostId = null;

        // é¡¯ç¤ºè‡ªè¨‚è¨Šæ¯è¦–çª—çš„å‡½å¼
        const showAlert = (message, title = 'ç³»çµ±è¨Šæ¯') => {
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            alertModal.classList.remove('hidden');
        };

        // åˆå§‹åŒ–
        const init = () => {
            setupEventListeners();
            applyModeRestrictions();
            loadLikedPostsFromLocal();
            
            // åˆå§‹åŒ–é¢¨æ ¼è¨­å®š
            applyStyle();
            updateStyleButton();
            updateUIText();

            if (firebaseConfig.apiKey === "YOUR_API_KEY" || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
                wallContainer.innerHTML = '<div class="text-center text-gray-500 p-8 w-full">å°šæœªè¨­å®š Firebaseã€‚è«‹é»æ“Šå³ä¸Šè§’çš„ â“ æŒ‰éˆ•ï¼Œä¾ç…§èªªæ˜å®Œæˆè¨­å®šã€‚</div>';
                return; 
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                signInAnonymously(auth).catch(error => {
                    console.error("åŒ¿åç™»å…¥å¤±æ•—:", error);
                    showAlert("ç„¡æ³•é€£æ¥åˆ°èªè­‰æœå‹™ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨ã€‚", "éŒ¯èª¤");
                });

                onAuthStateChanged(auth, async user => {
                    if (user) {
                        console.log("å·²åŒ¿åç™»å…¥ï¼Œä½¿ç”¨è€… ID:", user.uid);
                        
                        // ç‚ºèˆŠå­˜æª”åˆ†é…ä»£ç¢¼
                        assignCodesForOldArchives();
                        
                        // æª¢æŸ¥æ˜¯å¦æœ‰URLåƒæ•¸è¦è¼‰å…¥ç‰¹å®šè³‡æ–™
                        if (dataParam) {
                            console.log("æª¢æ¸¬åˆ°è³‡æ–™åƒæ•¸:", dataParam);
                            const loaded = await loadDataByCode(dataParam);
                            if (loaded) {
                                // å¦‚æœæˆåŠŸè¼‰å…¥ï¼Œç­‰å¾…ä¸€ä¸‹è®“è³‡æ–™åŒæ­¥ï¼Œç„¶å¾Œè¨­ç½®ç›£è½å™¨
                                setTimeout(() => {
                                    setupRealtimeListeners();
                                }, 1000);
                            } else {
                                // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œè¼‰å…¥é è¨­è³‡æ–™
                                loadInitialData();
                                setupRealtimeListeners();
                            }
                        } else {
                            loadInitialData();
                            setupRealtimeListeners();
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
                showAlert(`Firebase åˆå§‹åŒ–å¤±æ•—ï¼è«‹æª¢æŸ¥æ‚¨çš„è¨­å®šæ˜¯å¦æ­£ç¢ºã€‚\n\néŒ¯èª¤è¨Šæ¯: ${error.message}`, "åš´é‡éŒ¯èª¤");
                wallContainer.innerHTML = `<div class="text-center text-red-500 p-8 w-full">Firebase åˆå§‹åŒ–å¤±æ•—ï¼<br>è«‹æŒ‰ F12 æŸ¥çœ‹é–‹ç™¼è€…å·¥å…·ä¸­çš„è©³ç´°éŒ¯èª¤è¨Šæ¯ï¼Œä¸¦ç¢ºèªæ‚¨çš„ firebaseConfig æ˜¯å¦æ­£ç¢ºã€‚</div>`;
            }
        };

        // æ ¹æ“šæ¨¡å¼ï¼ˆä¸€èˆ¬/å­¸ç”Ÿï¼‰å¥—ç”¨ä»‹é¢é™åˆ¶
        const applyModeRestrictions = () => {
            if (isStudentMode) {
                newPlurkSection.classList.add('hidden');
                newWallBtn.classList.add('hidden');
                styleToggleBtn.classList.add('hidden');
                studentModeBtn.classList.add('hidden');
                settingBgBtn.classList.add('hidden');
                helpBtn.classList.add('hidden');
                mainTitleInput.readOnly = true;
                saveBtn.classList.add('hidden');
                openBtn.classList.add('hidden');
                exportBtn.classList.add('hidden');
                importBtn.classList.add('hidden');
                downloadHtmlBtn.classList.add('hidden');
            }
        };

        // é¡¯ç¤º/éš±è—åŒæ­¥ç‹€æ…‹æç¤º
        const showSyncStatus = (isSyncing, isError = false, message = '') => {
            clearTimeout(syncStatusTimer);
            syncStatus.classList.remove('opacity-0');
            syncStatus.classList.remove('bg-gray-800', 'bg-green-600', 'bg-red-500');

            if (isSyncing) {
                syncStatus.textContent = message || 'èˆ‡é›²ç«¯åŒæ­¥ä¸­...';
                syncStatus.classList.add('bg-gray-800');
            } else {
                if (isError) {
                    syncStatus.textContent = message || 'åŒæ­¥å¤±æ•—ï¼';
                    syncStatus.classList.add('bg-red-500');
                } else {
                    syncStatus.textContent = message || 'åŒæ­¥å®Œæˆï¼';
                    syncStatus.classList.add('bg-green-600');
                }
                syncStatusTimer = setTimeout(() => {
                    syncStatus.classList.add('opacity-0');
                }, 2000);
            }
        };

        // é¡¯ç¤ºè‡ªè¨‚ç¢ºèªè¦–çª—
        const showConfirm = (message, onConfirm) => {
            confirmMsg.textContent = message;
            confirmCallback = onConfirm;
            confirmModal.classList.remove('hidden');
        };

        // éš±è—è‡ªè¨‚ç¢ºèªè¦–çª—
        const hideConfirm = () => {
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        };
        
        const checkFirebase = () => {
            if (!db) {
                showAlert('è«‹å…ˆå®Œæˆ Firebase è¨­å®šï¼é»æ“Šå³ä¸Šè§’ã€Œâ“ã€æŸ¥çœ‹èªªæ˜ã€‚');
                return false;
            }
            return true;
        };

        // å¾ LocalStorage è¼‰å…¥æŒ‰è®šç´€éŒ„
        const loadLikedPostsFromLocal = () => {
            const localLiked = localStorage.getItem('plurk_liked_posts');
            if (localLiked) {
                likedPosts = new Set(JSON.parse(localLiked));
            }
        };

        // å°‡æŒ‰è®šç´€éŒ„å­˜åˆ° LocalStorage
        const saveLikedPostsToLocal = () => {
            localStorage.setItem('plurk_liked_posts', JSON.stringify([...likedPosts]));
        };

        // è¼‰å…¥åˆå§‹è³‡æ–™ (åƒ…åŸ·è¡Œä¸€æ¬¡)
        const loadInitialData = async () => {
            if (!checkFirebase()) return;
            const settingsDoc = await getDoc(doc(db, "settings", "config"));
            if (settingsDoc.exists()) {
                const data = settingsDoc.data();
                mainTitleInput.value = data.mainTitle || 'Plurk é¢¨æ ¼å›æ‡‰ç‰† (Firebase ç‰ˆ)';
                if (data.backgroundUrl) {
                    wallContainer.style.backgroundImage = `url('${data.backgroundUrl}')`;
                }
            }
        };

        // è¨­å®šå³æ™‚è³‡æ–™ç›£è½
        const setupRealtimeListeners = () => {
            if (!checkFirebase()) return;

            unsubscribeSettings = onSnapshot(doc(db, "settings", "config"), (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    mainTitleInput.value = data.mainTitle || 'Plurk é¢¨æ ¼å›æ‡‰ç‰† (Firebase ç‰ˆ)';
                    if (data.backgroundUrl) {
                        wallContainer.style.backgroundImage = `url('${data.backgroundUrl}')`;
                    }
                }
            });

            const q = query(collection(db, "sections"), orderBy("createdAt", "desc"));
            
            unsubscribeSections = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const sectionId = change.doc.id;
                    const sectionData = change.doc.data();

                    if (change.type === "added") {
                        if (!sections.some(s => s.id === sectionId)) {
                            const newSection = { id: sectionId, ...sectionData, posts: [] };
                            sections.push(newSection); 

                            const postsQuery = query(collection(db, `sections/${sectionId}/posts`), orderBy("createdAt", "desc"));
                            postUnsubscribers[sectionId] = onSnapshot(postsQuery, (postsSnapshot) => {
                                const targetSectionIndex = sections.findIndex(s => s.id === sectionId);
                                if (targetSectionIndex > -1) {
                                    sections[targetSectionIndex].posts = postsSnapshot.docs.map(postDoc => ({ id: postDoc.id, ...postDoc.data() }));
                                    renderApp(); 
                                }
                            });
                        }
                    }
                    if (change.type === "modified") {
                        const targetSectionIndex = sections.findIndex(s => s.id === sectionId);
                        if (targetSectionIndex > -1) {
                            sections[targetSectionIndex] = { ...sections[targetSectionIndex], ...sectionData };
                        }
                    }
                    if (change.type === "removed") {
                        if (postUnsubscribers[sectionId]) {
                            postUnsubscribers[sectionId]();
                            delete postUnsubscribers[sectionId];
                        }
                        sections = sections.filter(s => s.id !== sectionId);
                    }
                });

                sections.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                renderApp();
            });
        };

        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        const setupEventListeners = () => {
            alertOkBtn.addEventListener('click', () => alertModal.classList.add('hidden'));

            mainTitleInput.addEventListener('blur', async (e) => {
                if (!checkFirebase()) return;
                const newTitle = e.target.value || 'Plurk é¢¨æ ¼å›æ‡‰ç‰† (Firebase ç‰ˆ)';
                try {
                    await setDoc(doc(db, "settings", "config"), { mainTitle: newTitle }, { merge: true });
                } catch(error) {
                    console.error("æ›´æ–°æ¨™é¡Œå¤±æ•—:", error);
                }
            });

            addSectionBtn.addEventListener('click', addSection);
            newPlurkInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addSection();
            });
            
            // æ–°å¢å™—æ–‡é¡å‹åˆ‡æ›
            document.querySelectorAll('input[name="new-plurk-type"]').forEach(radio => {
                radio.addEventListener('change', handleNewPlurkTypeChange);
            });
            document.getElementById('new-plurk-file').addEventListener('change', (e) => handleImageUpload(e.target.files[0], 'new-plurk'));

            closeModalBtn.addEventListener('click', closeModal);
            postModal.addEventListener('click', (e) => {
                if (e.target === postModal) closeModal();
            });
            postForm.addEventListener('submit', handleFormSubmit);
            postForm.querySelectorAll('input[name="post-type"]').forEach(radio => {
                radio.addEventListener('change', handleTypeChange);
            });

            dropZone.addEventListener('click', () => imageUpload.click());
            imageUpload.addEventListener('change', (e) => handleImageUpload(e.target.files[0], 'response'));
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, handleDragEvents, false);
            });
            dropZone.addEventListener('drop', handleImageDrop);

            helpBtn.addEventListener('click', () => helpModal.classList.remove('hidden'));
            closeHelpModalBtn.addEventListener('click', () => helpModal.classList.add('hidden'));
            helpModal.addEventListener('click', (e) => {
                if (e.target === helpModal) helpModal.classList.add('hidden');
            });

            studentModeBtn.addEventListener('click', () => {
                const baseUrl = window.location.href.split('?')[0];
                const studentUrl = baseUrl + '?mode=student';
                studentUrlInput.value = studentUrl;
                
                const qrcodeContainer = document.getElementById('qrcode-container');
                qrcodeContainer.innerHTML = ''; 
                try {
                    new QRCode(qrcodeContainer, {
                        text: studentUrl,
                        width: 192,
                        height: 192,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                } catch (e) {
                    qrcodeContainer.innerHTML = '<p class="text-red-500 text-center">ç„¡æ³•ç”ŸæˆQR Codeï¼Œå› ç‚ºç¶²å€å¤ªé•·äº†ã€‚<br>è«‹å°‡æ­¤htmlæª”æ¡ˆæ”¹åç‚ºç°¡çŸ­çš„è‹±æ–‡åç¨±å¾Œå†è©¦ä¸€æ¬¡ã€‚</p>';
                    console.error("QR Code generation error:", e);
                }

                studentModeModal.classList.remove('hidden');
            });
            closeStudentModalBtn.addEventListener('click', () => studentModeModal.classList.add('hidden'));
            copyStudentUrlBtn.addEventListener('click', () => {
                studentUrlInput.select();
                document.execCommand('copy');
                showAlert('å­¸ç”Ÿæ¨¡å¼ç¶²å€å·²è¤‡è£½ï¼');
            });
            openStudentUrlBtn.addEventListener('click', () => {
                window.open(studentUrlInput.value, '_blank');
            });
            
            settingBgBtn.addEventListener('click', () => settingBgModal.classList.remove('hidden'));
            closeBgModalBtn.addEventListener('click', () => {
                settingBgModal.classList.add('hidden');
                uploadedBgImageData = null;
                document.getElementById('bg-upload-filename').textContent = '';
            });
            bgDropZone.addEventListener('click', () => bgImageUpload.click());
            bgImageUpload.addEventListener('change', (e) => handleImageUpload(e.target.files[0], 'background'));
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                bgDropZone.addEventListener(eventName, (e) => {
                    e.preventDefault(); e.stopPropagation();
                    if (e.type === 'dragenter' || e.type === 'dragover') {
                        bgDropZone.classList.add('bg-gray-100');
                    } else if (e.type === 'dragleave') {
                        bgDropZone.classList.remove('bg-gray-100');
                    }
                }, false);
            });
            bgDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                bgDropZone.classList.remove('bg-gray-100');
                const files = e.dataTransfer.files;
                if (files.length > 0) handleImageUpload(files[0], 'background');
            });
            submitBgBtn.addEventListener('click', async () => {
                if (!checkFirebase()) return;
                if (uploadedBgImageData) {
                    showSyncStatus(true, false, 'è¨­å®šèƒŒæ™¯ä¸­...');
                    try {
                        await setDoc(doc(db, "settings", "config"), { backgroundUrl: uploadedBgImageData }, { merge: true });
                        showSyncStatus(false, false, 'èƒŒæ™¯å·²æ›´æ–°ï¼');
                        settingBgModal.classList.add('hidden');
                        uploadedBgImageData = null;
                        document.getElementById('bg-upload-filename').textContent = '';
                    } catch (error) {
                        console.error("æ›´æ–°èƒŒæ™¯å¤±æ•—:", error);
                        showAlert(`æ›´æ–°èƒŒæ™¯å¤±æ•—ï¼å¯èƒ½æ˜¯åœ–ç‰‡æª”æ¡ˆå¤ªå¤§ã€‚\n${error.message}`, "éŒ¯èª¤");
                        showSyncStatus(false, true);
                    }
                } else {
                    showAlert('è«‹å…ˆé¸æ“‡ä¸€å¼µåœ–ç‰‡ï¼');
                }
            });
            restoreBgBtn.addEventListener('click', restoreDefaultBackground);

            // é—œé–‰åœ–ç‰‡æª¢è¦–å™¨
            const closeImageViewerBtn = document.getElementById('close-image-viewer-btn');
            const closeImageViewer = () => {
                imageViewer.classList.add('hidden');
                resetImageZoom();
            };

            closeImageViewerBtn.addEventListener('click', closeImageViewer);
            imageViewer.addEventListener('click', (e) => {
                if (e.target === imageViewer) {
                    closeImageViewer();
                }
            });

            // åœ–ç‰‡ç¸®æ”¾åŠŸèƒ½
            const imageContainer = document.getElementById('image-container');
            const imageContent = document.querySelector('.image-content');
            let currentScale = 1;
            let initialDistance = 0;
            let lastScale = 1;

            // é‡ç½®åœ–ç‰‡ç¸®æ”¾
            const resetImageZoom = () => {
                currentScale = 1;
                lastScale = 1;
                imageContent.style.transform = 'scale(1)';
            };

            // è¨­ç½®åœ–ç‰‡ç¸®æ”¾
            const setImageScale = (scale) => {
                const minScale = 0.5;
                const maxScale = 5;
                currentScale = Math.max(minScale, Math.min(maxScale, scale));
                imageContent.style.transform = `scale(${currentScale})`;
            };

            // PC æ»‘é¼ æ»¾è¼ªç¸®æ”¾
            imageContainer.addEventListener('wheel', (e) => {
                e.preventDefault();
                const zoomFactor = 0.1;
                const delta = e.deltaY > 0 ? -zoomFactor : zoomFactor;
                setImageScale(currentScale + delta);
            });

            // iPad è§¸æ§ç¸®æ”¾
            let touches = {};
            
            imageContainer.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touchList = e.touches;
                
                if (touchList.length === 2) {
                    // é›™æŒ‡è§¸æ§é–‹å§‹
                    const touch1 = touchList[0];
                    const touch2 = touchList[1];
                    
                    touches.touch1 = { x: touch1.clientX, y: touch1.clientY };
                    touches.touch2 = { x: touch2.clientX, y: touch2.clientY };
                    
                    initialDistance = Math.sqrt(
                        Math.pow(touch2.clientX - touch1.clientX, 2) +
                        Math.pow(touch2.clientY - touch1.clientY, 2)
                    );
                    lastScale = currentScale;
                }
            });

            imageContainer.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touchList = e.touches;
                
                if (touchList.length === 2 && initialDistance > 0) {
                    const touch1 = touchList[0];
                    const touch2 = touchList[1];
                    
                    const currentDistance = Math.sqrt(
                        Math.pow(touch2.clientX - touch1.clientX, 2) +
                        Math.pow(touch2.clientY - touch1.clientY, 2)
                    );
                    
                    const scale = lastScale * (currentDistance / initialDistance);
                    setImageScale(scale);
                }
            });

            imageContainer.addEventListener('touchend', (e) => {
                const touchList = e.touches;
                if (touchList.length < 2) {
                    initialDistance = 0;
                    touches = {};
                }
            });

            // åœ–ç‰‡è¼‰å…¥æ™‚é‡ç½®ç¸®æ”¾
            imageContent.addEventListener('load', resetImageZoom);

            confirmOkBtn.addEventListener('click', () => {
                if (typeof confirmCallback === 'function') {
                    confirmCallback();
                }
                hideConfirm();
            });
            confirmCancelBtn.addEventListener('click', hideConfirm);
            confirmModal.addEventListener('click', (e) => {
                 if (e.target === confirmModal) hideConfirm();
            });

            newWallBtn.addEventListener('click', createNewWall);
            styleToggleBtn.addEventListener('click', toggleStyle);
            saveBtn.addEventListener('click', saveArchive);
            openBtn.addEventListener('click', openArchiveModal);
            exportBtn.addEventListener('click', exportData);
            importBtn.addEventListener('click', () => importModal.classList.remove('hidden'));
            downloadHtmlBtn.addEventListener('click', downloadHtml);
            closeOpenModalBtn.addEventListener('click', () => {
                openModalEl.classList.add('hidden');
                if (unsubscribeArchives) {
                    unsubscribeArchives();
                    unsubscribeArchives = null;
                }
            });
            closeImportModalBtn.addEventListener('click', () => {
                importModal.classList.add('hidden');
                importData = null;
            });
            importDropZone.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', (e) => handleFileImport(e.target.files[0]));
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                importDropZone.addEventListener(eventName, (e) => {
                    e.preventDefault(); e.stopPropagation();
                    if (e.type === 'dragenter' || e.type === 'dragover') {
                        importDropZone.classList.add('bg-gray-100');
                    } else if (e.type === 'dragleave') {
                        importDropZone.classList.remove('bg-gray-100');
                    }
                }, false);
            });
            importDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                importDropZone.classList.remove('bg-gray-100');
                const files = e.dataTransfer.files;
                if (files.length > 0) handleFileImport(files[0]);
            });
            
            // å¡—é´‰ç›¸é—œäº‹ä»¶ç›£è½
            setupDrawingEventListeners();
            
            // å±•é–‹å›æ‡‰è¦–çª—äº‹ä»¶ç›£è½
            closeResponsesBtn.addEventListener('click', () => responsesModal.classList.add('hidden'));
            responsesModal.addEventListener('click', (e) => {
                if (e.target === responsesModal) responsesModal.classList.add('hidden');
            });
        };

        // æ¸²æŸ“æ‡‰ç”¨
        const renderApp = () => {
            wallContainer.innerHTML = '';

            if (sections.length === 0 && db) {
                wallContainer.innerHTML = '<div class="text-center text-gray-500 p-8 w-full">é‚„æ²’æœ‰ä»»ä½•å™—æ–‡ï¼Œå¿«ä¾†ç™¼è¡¨ç¬¬ä¸€å‰‡å§ï¼</div>';
                return;
            }

            // åœ¨Padleté¢¨æ ¼ä¸‹åè½‰å€æ®µé †åº
            const sectionsToRender = isPadletStyle ? [...sections].reverse() : sections;
            
            sectionsToRender.forEach(section => {
                const sectionEl = createSectionElement(section);
                wallContainer.appendChild(sectionEl);
            });
        };

        // å‰µå»ºå™—æ–‡å…ƒç´ 
        const createSectionElement = (section) => {
            const sectionEl = document.createElement('div');
            sectionEl.className = 'section-column';
            sectionEl.dataset.id = section.id;

            let sectionImageHtml = '';
            if (section.type === 'text_image' && section.imageUrl) {
                sectionImageHtml = `<div class="mt-2 section-image-container"><img src="${section.imageUrl}" alt="" class="viewable-image w-full max-w-full h-auto object-cover rounded-md border border-gray-200 cursor-pointer"></div>`;
            }

            // å±•é–‹æŒ‰éˆ•HTML (åªæœ‰æ•™å¸«æ¨¡å¼æ‰é¡¯ç¤º)
            const expandBtnHtml = !isStudentMode ? `<button class="expand-responses-btn ml-2 p-1 text-gray-400 hover:text-blue-500" title="å±•é–‹æ‰€æœ‰å›æ‡‰">ğŸ“‹</button>` : '';
            
            // åœ–ç‰‡åˆ‡æ›æŒ‰éˆ•HTML (å¦‚æœæœ‰åœ–ç‰‡å°±é¡¯ç¤º)
            const imageToggleBtnHtml = (section.type === 'text_image' && section.imageUrl) ? `<button class="image-toggle-btn ml-2 p-1 text-gray-400 hover:text-blue-500" title="éš±è—åœ–ç‰‡">ğŸ–¼ï¸</button>` : '';
            
            sectionEl.innerHTML = `
                <div class="section-header" onclick="toggleSection('${section.id}')">
                    <div class="plurk-avatar">P</div>
                    <div class="flex-grow">
                        <div class="flex items-center mb-2">
                            <span class="toggle-btn mr-2 text-lg">â–¼</span>
                            <span class="font-bold text-orange-600 mr-2">è€å¸«</span>
                            <span class="plurk-qualifier">èªª</span>
                            ${expandBtnHtml}
                            ${imageToggleBtnHtml}
                            <button class="delete-section-btn ml-auto p-1 text-gray-400 hover:text-red-500" title="åˆªé™¤æ­¤å™—">ğŸ—‘ï¸</button>
                        </div>
                        <textarea class="section-title-input preserve-lines" rows="1" placeholder="é»æ“Šé€™è£¡ç·¨è¼¯å™—æ–‡å…§å®¹...">${section.title}</textarea>
                        ${sectionImageHtml}
                    </div>
                </div>
                <div class="section-add-post">
                    <button class="add-post-btn theme-button bg-white hover:bg-gray-100 w-full py-1 rounded-md text-sm text-gray-600 font-bold">+ æ–°å¢å›æ‡‰</button>
                </div>
                <div class="section-posts"></div>
                <div class="section-footer p-2 border-t border-gray-200 bg-gray-50 rounded-b-lg">
                    <button class="add-post-btn-footer theme-button bg-white hover:bg-gray-100 w-full py-1 rounded-md text-sm text-gray-600 font-bold">+ æ–°å¢å›æ‡‰</button>
                </div>
            `;
            
            const titleInput = sectionEl.querySelector('.section-title-input');
            const deleteBtn = sectionEl.querySelector('.delete-section-btn');
            const expandBtn = sectionEl.querySelector('.expand-responses-btn');
            const imageToggleBtn = sectionEl.querySelector('.image-toggle-btn');

            if (isStudentMode) {
                titleInput.readOnly = true;
                if(deleteBtn) deleteBtn.remove();
            } else {
                titleInput.addEventListener('blur', () => {
                    updateSectionTitle(section.id, titleInput.value);
                });
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteSection(section.id);
                });
                
                // å±•é–‹å›æ‡‰æŒ‰éˆ•äº‹ä»¶
                if (expandBtn) {
                    expandBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openResponsesModal(sectionEl);
                    });
                }
            }
            
            // åœ–ç‰‡åˆ‡æ›æŒ‰éˆ•äº‹ä»¶ (å­¸ç”Ÿå’Œè€å¸«éƒ½å¯ä»¥ä½¿ç”¨)
            if (imageToggleBtn) {
                imageToggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleSectionImage(sectionEl);
                });
            }
            
            titleInput.addEventListener('input', autoResizeTextarea);
            setTimeout(() => autoResizeTextarea({target: titleInput}), 0);

            const postsContainer = sectionEl.querySelector('.section-posts');
            renderPosts(postsContainer, section.posts, section.id);

            // ç‚ºå…©å€‹æ–°å¢å›æ‡‰æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
            const addPostBtns = sectionEl.querySelectorAll('.add-post-btn, .add-post-btn-footer');
            addPostBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // è¨˜éŒ„åŸå§‹å™—æ–‡çš„åœ–ç‰‡ä»¥ä¾›å¡—é´‰ä½¿ç”¨
                    originalPostImages = [];
                    if (section.type === 'text_image' && section.imageUrl) {
                        originalPostImages.push(section.imageUrl);
                    }
                    // ä¹ŸæŸ¥æ‰¾å›æ‡‰ä¸­çš„åœ–ç‰‡
                    if (section.posts) {
                        section.posts.forEach(post => {
                            if ((post.type === 'image_url' || post.type === 'image_upload') && post.url) {
                                originalPostImages.push(post.url);
                            }
                        });
                    }
                    openModal('æ–°å¢å›æ‡‰', section.id);
                });
            });
            
            // ç‚ºå™—æ–‡ä¸­çš„åœ–ç‰‡åŠ ä¸Šé»æ“Šæ”¾å¤§åŠŸèƒ½
            const sectionImg = sectionEl.querySelector('.viewable-image');
            if (sectionImg) {
                sectionImg.addEventListener('click', () => {
                    imageViewer.querySelector('.image-content').src = sectionImg.src;
                    imageViewer.classList.remove('hidden');
                });
            }

            return sectionEl;
        };

        // æ¸²æŸ“å›æ‡‰
        const renderPosts = (container, posts, sectionId) => {
            container.innerHTML = '';
            if (!posts) return;

            posts.forEach(post => {
                const postEl = document.createElement('div');
                postEl.className = 'post-card';
                postEl.dataset.id = post.id;

                let mediaHtml = '';
                switch (post.type) {
                    case 'image_url':
                    case 'image_upload':
                        mediaHtml = `<div class="mt-2"><img src="${post.url}" alt="${post.title}" class="viewable-image w-full max-w-full h-auto object-cover rounded-md border border-gray-200 cursor-pointer" onerror="this.onerror=null;this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2NjIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzAwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWcluePh+i8ieWFpeWksei0pTwvdGV4dD48L3N2Zz4='"></div>`;
                        break;
                    case 'youtube':
                        const embedUrl = getYoutubeEmbedUrl(post.url);
                        if (embedUrl) {
                            mediaHtml = `<div class="aspect-w-16 aspect-h-9 mt-2 border border-gray-200 rounded-md overflow-hidden"><iframe src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full h-full"></iframe></div>`;
                        }
                        break;
                    case 'link':
                        mediaHtml = `<a href="${post.url}" target="_blank" rel="noopener noreferrer" class="block mt-2 p-2 bg-gray-100 rounded border border-gray-200 text-blue-600 hover:underline break-all text-sm">${post.url}</a>`;
                        break;
                    case 'drawing':
                        mediaHtml = `<div class="mt-2"><img src="${post.url}" alt="å¡—é´‰ä½œå“" class="viewable-image w-full max-w-full h-auto object-cover rounded-md border border-gray-200 cursor-pointer"></div>`;
                        break;
                }

                const isLiked = likedPosts.has(post.id);
                const avatarChar = (String(post.title || '')[0] || 'R').toUpperCase();

                postEl.innerHTML = `
                    <div class="reply-avatar">${avatarChar}</div>
                    <div class="flex-grow">
                        <div class="flex justify-between items-start mb-1">
                            <h3 class="font-bold text-sm text-gray-800 break-words">${post.title}</h3>
                            <div class="flex items-center text-xs text-gray-500 flex-shrink-0 ml-2">
                                <span class="font-bold text-sm mr-1">${post.likes || 0}</span>
                                <button class="like-btn ${isLiked ? 'liked' : ''}" title="${isLiked ? 'å·²è®š' : 'å–œæ­¡'}">â¤ï¸</button>
                                <div class="post-controls flex space-x-1 flex-shrink-0 ml-2">
                                    <button class="edit-btn p-1 text-gray-400 hover:text-blue-500" title="ç·¨è¼¯">âœï¸</button>
                                    <button class="delete-btn p-1 text-gray-400 hover:text-red-500" title="åˆªé™¤">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                        </div>
                        <div class="text-sm text-gray-700 preserve-lines break-words">${post.content}</div>
                        ${mediaHtml}
                    </div>
                `;

                postEl.querySelector('.like-btn').addEventListener('click', (e) => {
                    const likeBtn = e.target;
                    const likesSpan = likeBtn.previousElementSibling;
                    likePost(sectionId, post.id, likesSpan, likeBtn);
                });
                
                const controls = postEl.querySelector('.post-controls');
                if (isStudentMode) {
                    controls.remove();
                } else {
                    controls.querySelector('.edit-btn').addEventListener('click', () => editPost(sectionId, post.id));
                    controls.querySelector('.delete-btn').addEventListener('click', () => deletePost(sectionId, post.id));
                }

                const img = postEl.querySelector('.viewable-image');
                if (img) {
                    img.addEventListener('click', () => {
                        imageViewer.querySelector('.image-content').src = img.src;
                        imageViewer.classList.remove('hidden');
                    });
                }

                container.appendChild(postEl);
            });
        };

        // è™•ç†æ–°å™—æ–‡é¡å‹åˆ‡æ›
        const handleNewPlurkTypeChange = (e) => {
            const uploadDiv = document.getElementById('new-plurk-upload');
            if (e.target.value === 'text_image') {
                uploadDiv.classList.remove('hidden');
            } else {
                uploadDiv.classList.add('hidden');
                newPlurkUploadedImage = null;
                document.getElementById('new-plurk-file').value = '';
            }
        };
        
        // æ–°å¢å™—æ–‡
        const addSection = async () => {
            if (!checkFirebase()) return;
            const content = newPlurkInput.value.trim();
            const type = document.querySelector('input[name="new-plurk-type"]:checked').value;
            
            if (!content) {
                showAlert('è«‹è¼¸å…¥å™—æ–‡å…§å®¹');
                return;
            }
            
            if (type === 'text_image' && !newPlurkUploadedImage) {
                showAlert('è«‹é¸æ“‡è¦ä¸Šå‚³çš„åœ–ç‰‡');
                return;
            }

            const newSection = {
                title: content,
                createdAt: serverTimestamp(),
                type: type,
                imageUrl: type === 'text_image' ? newPlurkUploadedImage : null
            };
            
            showSyncStatus(true, false, 'ç™¼ä½ˆä¸­...');
            try {
                await addDoc(collection(db, "sections"), newSection);
                newPlurkInput.value = '';
                newPlurkUploadedImage = null;
                document.getElementById('new-plurk-file').value = '';
                document.querySelector('input[name="new-plurk-type"][value="text"]').checked = true;
                handleNewPlurkTypeChange({target: {value: 'text'}});
                showSyncStatus(false, false, 'ç™¼ä½ˆæˆåŠŸï¼');
            } catch (error) {
                console.error("æ–°å¢å™—æ–‡å¤±æ•—:", error);
                showAlert("æ–°å¢å™—æ–‡å¤±æ•—ï¼", "éŒ¯èª¤");
                showSyncStatus(false, true);
            }
        };

        // æ›´æ–°å™—æ–‡æ¨™é¡Œ
        const updateSectionTitle = async (sectionId, newTitle) => {
            if (!checkFirebase()) return;
            const sectionRef = doc(db, "sections", sectionId);
            try {
                await updateDoc(sectionRef, { title: newTitle });
            } catch (error) {
                console.error("æ›´æ–°å™—æ–‡æ¨™é¡Œå¤±æ•—:", error);
            }
        };

        // åˆªé™¤å™—æ–‡
        const deleteSection = (sectionId) => {
            if (!checkFirebase()) return;
            showConfirm('ç¢ºå®šè¦åˆªé™¤æ­¤å™—æ–‡å—ï¼Ÿæ‰€æœ‰å›æ‡‰ä¹Ÿæœƒä¸€èµ·åˆªé™¤ã€‚', async () => {
                showSyncStatus(true, false, 'åˆªé™¤ä¸­...');
                try {
                    const postsQuery = query(collection(db, `sections/${sectionId}/posts`));
                    const postsSnapshot = await getDocs(postsQuery);
                    const batch = writeBatch(db);
                    postsSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();

                    await deleteDoc(doc(db, "sections", sectionId));
                    showSyncStatus(false, false, 'åˆªé™¤æˆåŠŸï¼');
                } catch (error) {
                    console.error("åˆªé™¤å™—æ–‡å¤±æ•—:", error);
                    showAlert("åˆªé™¤å™—æ–‡å¤±æ•—ï¼", "éŒ¯èª¤");
                    showSyncStatus(false, true);
                }
            });
        };

        // é–‹å•Ÿæ¨¡æ…‹æ¡†
        const openModal = (title, sectionId, postId = null) => {
            if (!checkFirebase()) return;
            document.getElementById('modal-title').textContent = title;
            document.getElementById('section-id').value = sectionId;
            document.getElementById('post-id').value = postId || '';
            
            currentSectionId = sectionId;
            currentPostId = postId;

            if (postId && !isStudentMode) {
                const section = sections.find(s => s.id === sectionId);
                const post = section?.posts.find(p => p.id === postId);
                if (post) {
                    document.getElementById('post-title').value = post.title;
                    document.getElementById('post-content').value = post.content;
                    document.getElementById('post-url').value = post.type !== 'image_upload' && post.type !== 'drawing' ? (post.url || '') : '';
                    document.querySelector(`input[name="post-type"][value="${post.type}"]`).checked = true;
                    handleTypeChange({ target: document.querySelector(`input[name="post-type"][value="${post.type}"]`) });
                    submitBtn.textContent = 'æ›´æ–°å›æ‡‰';
                }
            } else {
                postForm.reset();
                document.querySelector('input[name="post-type"][value="text"]').checked = true;
                handleTypeChange({ target: document.querySelector('input[name="post-type"][value="text"]') });
                submitBtn.textContent = 'é€å‡ºå›æ‡‰';
            }
            postModal.classList.remove('hidden');
        };
        
        const closeModal = () => {
            postModal.classList.add('hidden');
            postForm.reset();
            document.getElementById('upload-filename').textContent = '';
            uploadedImageData = null;
            drawingData = null;
            const existingBtn = document.querySelector('.drawing-open-btn');
            if (existingBtn) existingBtn.remove();
        };

        // è™•ç†è¡¨å–®æäº¤
        const handleFormSubmit = async (e) => {
            e.preventDefault();
            if (!checkFirebase()) return;

            const sectionId = document.getElementById('section-id').value;
            const postId = document.getElementById('post-id').value;
            const type = postForm.querySelector('input[name="post-type"]:checked').value;
            const title = document.getElementById('post-title').value;
            const content = document.getElementById('post-content').value;
            const url = document.getElementById('post-url').value;

            if (!title.trim()) {
                showAlert('è«‹è¼¸å…¥æš±ç¨±');
                return;
            }

            let finalUrl = url;

            if (type === 'image_upload') {
                if (uploadedImageData) {
                    finalUrl = uploadedImageData;
                } else if (!postId) {
                    showAlert('è«‹é¸æ“‡è¦ä¸Šå‚³çš„åœ–ç‰‡');
                    return;
                } else {
                    const section = sections.find(s => s.id === sectionId);
                    const post = section?.posts.find(p => p.id === postId);
                    finalUrl = post.url;
                }
            } else if (type === 'drawing') {
                if (drawingData) {
                    finalUrl = drawingData;
                } else if (!postId) {
                    showAlert('è«‹å…ˆå®Œæˆå¡—é´‰');
                    return;
                } else {
                    const section = sections.find(s => s.id === sectionId);
                    const post = section?.posts.find(p => p.id === postId);
                    finalUrl = post.url;
                }
            } else if ((type === 'text' && !content.trim()) || 
                ((type === 'image_url' || type === 'youtube' || type === 'link') && !finalUrl.trim())) {
                showAlert('è«‹å¡«å¯«å¿…è¦å…§å®¹');
                return;
            }

            showSyncStatus(true, false, postId ? 'æ›´æ–°ä¸­...' : 'æ–°å¢ä¸­...');
            
            try {
                const postData = {
                    title: title.trim(),
                    content: content.trim(),
                    type: type,
                    url: finalUrl,
                };

                if (postId && !isStudentMode) {
                    const postRef = doc(db, `sections/${sectionId}/posts`, postId);
                    await updateDoc(postRef, postData);
                } else {
                    postData.likes = 0;
                    postData.createdAt = serverTimestamp();
                    await addDoc(collection(db, `sections/${sectionId}/posts`), postData);
                }
                
                showSyncStatus(false, false, postId ? 'æ›´æ–°æˆåŠŸï¼' : 'æ–°å¢æˆåŠŸï¼');
                closeModal();

            } catch (error) {
                console.error("æäº¤å›æ‡‰å¤±æ•—:", error);
                showAlert(`æäº¤å›æ‡‰å¤±æ•—ï¼å¯èƒ½æ˜¯åœ–ç‰‡æª”æ¡ˆå¤ªå¤§ã€‚\n${error.message}`, "éŒ¯èª¤");
                showSyncStatus(false, true);
            }
        };

        const editPost = (sectionId, postId) => {
            if(!isStudentMode) openModal('ç·¨è¼¯å›æ‡‰', sectionId, postId);
        }

        // åˆªé™¤å›æ‡‰
        const deletePost = (sectionId, postId) => {
            if(isStudentMode || !checkFirebase()) return;
            showConfirm('ç¢ºå®šè¦åˆªé™¤æ­¤å›æ‡‰å—ï¼Ÿ', async () => {
                showSyncStatus(true, false, 'åˆªé™¤ä¸­...');
                try {
                    await deleteDoc(doc(db, `sections/${sectionId}/posts`, postId));
                    showSyncStatus(false, false, 'åˆªé™¤æˆåŠŸï¼');
                } catch (error) {
                    console.error("åˆªé™¤å›æ‡‰å¤±æ•—:", error);
                    showAlert("åˆªé™¤å›æ‡‰å¤±æ•—ï¼", "éŒ¯èª¤");
                    showSyncStatus(false, true);
                }
            });
        };

        // æŒ‰è®š
        const likePost = async (sectionId, postId, likesSpan, likeBtn) => {
            if (!checkFirebase()) return;
            if (likedPosts.has(postId)) {
                showAlert('ä½ å·²ç¶“å°æ­¤å›æ‡‰æŒ‰éè®šäº†ï¼');
                return;
            }

            const postRef = doc(db, `sections/${sectionId}/posts`, postId);
            try {
                await setDoc(postRef, {
                    likes: increment(1)
                }, { merge: true });
                
                // ç²å–æ›´æ–°å¾Œçš„å¯¦éš›è®šæ•¸
                const updatedDoc = await getDoc(postRef);
                if (updatedDoc.exists()) {
                    const actualLikes = updatedDoc.data().likes || 0;
                    likesSpan.textContent = actualLikes;
                } else {
                    likesSpan.textContent = 1;
                }
                
                likeBtn.classList.add('liked');
                likeBtn.title = 'å·²è®š';
                
                likedPosts.add(postId);
                saveLikedPostsToLocal();
            } catch (error) {
                console.error("æŒ‰è®šå¤±æ•—:", error);
            }
        };

        // æ‘ºç–Šå™—æ–‡
        window.toggleSection = (sectionId) => {
            // åœ¨Padleté¢¨æ ¼ä¸‹ä¸åŸ·è¡Œæ”¶åˆåŠŸèƒ½
            if (isPadletStyle) {
                return;
            }
            
            const sectionEl = document.querySelector(`[data-id="${sectionId}"]`);
            if (sectionEl) {
                sectionEl.classList.toggle('collapsed');
            }
        };

        // åˆ‡æ›å™—æ–‡åœ–ç‰‡é¡¯ç¤º/éš±è—
        const toggleSectionImage = (sectionEl) => {
            const imageContainer = sectionEl.querySelector('.section-image-container');
            const imageToggleBtn = sectionEl.querySelector('.image-toggle-btn');
            
            if (imageContainer && imageToggleBtn) {
                if (imageContainer.style.display === 'none') {
                    imageContainer.style.display = '';
                    imageToggleBtn.textContent = 'ğŸ–¼ï¸';
                    imageToggleBtn.title = 'éš±è—åœ–ç‰‡';
                } else {
                    imageContainer.style.display = 'none';
                    imageToggleBtn.textContent = 'ğŸš«';
                    imageToggleBtn.title = 'é¡¯ç¤ºåœ–ç‰‡';
                }
            }
        };

        // --- æ–°å¢ï¼šå­˜æª”èˆ‡è®€æª”åŠŸèƒ½ ---

        const saveArchive = async () => {
            if (!checkFirebase()) return;
            const title = mainTitleInput.value.trim();
            if (!title) {
                showAlert('è«‹å…ˆç‚ºæ‚¨çš„å›æ‡‰ç‰†è¨­å®šä¸€å€‹ä¸»æ¨™é¡Œï¼Œæ‰èƒ½å­˜æª”ã€‚');
                return;
            }

            showConfirm(`ç¢ºå®šè¦å°‡ç›®å‰æ‰€æœ‰å…§å®¹ä»¥ã€Œ${title}ã€ç‚ºæª”åå­˜æª”å—ï¼Ÿ`, async () => {
                showSyncStatus(true, false, 'å­˜æª”ä¸­...');
                try {
                    const settingsDoc = await getDoc(doc(db, "settings", "config"));
                    const backgroundUrl = (settingsDoc.exists() && settingsDoc.data().backgroundUrl) ? settingsDoc.data().backgroundUrl : '';

                    const serializableSections = sections.map(section => ({
                        ...section,
                        createdAt: section.createdAt?.toDate().toISOString() || new Date().toISOString(),
                        posts: section.posts.map(post => ({
                            ...post,
                            createdAt: post.createdAt?.toDate().toISOString() || new Date().toISOString(),
                        }))
                    }));

                    const dataCode = await generateUniqueCode();
                    const archiveData = {
                        title: title,
                        backgroundUrl: backgroundUrl,
                        savedAt: serverTimestamp(),
                        sections: serializableSections,
                        dataCode: dataCode
                    };

                    await addDoc(collection(db, "archives"), archiveData);
                    showSyncStatus(false, false, 'å­˜æª”æˆåŠŸï¼');
                    showAlert(`å·²æˆåŠŸä»¥ã€Œ${title}ã€çš„åç¨±å„²å­˜æª”æ¡ˆã€‚`);
                } catch (error) {
                    console.error("å­˜æª”å¤±æ•—:", error);
                    showAlert(`å­˜æª”å¤±æ•—ï¼\n${error.message}`, "éŒ¯èª¤");
                    showSyncStatus(false, true);
                }
            });
        };

        const openArchiveModal = () => {
            if (!checkFirebase()) return;
            openModalEl.classList.remove('hidden');

            const q = query(collection(db, "archives"), orderBy("savedAt", "desc"));
            unsubscribeArchives = onSnapshot(q, (snapshot) => {
                archiveListContainer.innerHTML = '';
                if (snapshot.empty) {
                    archiveListContainer.innerHTML = '<p class="text-center text-gray-500">æ²’æœ‰ä»»ä½•å­˜æª”ã€‚</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const archive = doc.data();
                    const archiveId = doc.id;
                    const savedDate = archive.savedAt?.toDate().toLocaleString() || 'æœªçŸ¥æ—¥æœŸ';

                    const itemEl = document.createElement('div');
                    itemEl.className = 'p-3 border-b hover:bg-gray-50';
                    const dataCode = archive.dataCode || 'æœªè¨­å®š';
                    const baseUrl = window.location.href.split('?')[0];
                    const dataUrl = `${baseUrl}?data=${dataCode}`;
                    const studentUrl = `${baseUrl}?data=${dataCode}&mode=student`;
                    
                    itemEl.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <p class="font-bold">${archive.title}</p>
                                <p class="text-sm text-gray-500">å„²å­˜æ–¼ï¼š${savedDate}</p>
                                <p class="text-xs text-blue-600">ä»£ç¢¼ï¼š
                                    <input type="text" value="${dataCode}" class="data-code-input bg-transparent border-b border-dashed border-blue-400 text-blue-600 w-16 text-center text-xs" data-id="${archiveId}" data-original="${dataCode}">
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button data-id="${archiveId}" class="open-archive-btn theme-button bg-blue-500 text-white py-1 px-3 rounded-md text-sm">é–‹å•Ÿ</button>
                                <button data-id="${archiveId}" class="delete-archive-btn theme-button bg-red-500 text-white py-1 px-3 rounded-md text-sm">åˆªé™¤</button>
                            </div>
                        </div>
                        <div class="flex gap-2 text-xs">
                            <button class="copy-url-btn theme-button bg-green-500 text-white py-1 px-2 rounded text-xs" data-url="${dataUrl}">è¤‡è£½é€£çµ</button>
                            <button class="copy-student-url-btn theme-button bg-purple-500 text-white py-1 px-2 rounded text-xs" data-url="${studentUrl}">è¤‡è£½å­¸ç”Ÿæ¨¡å¼</button>
                            <button class="open-new-tab-btn theme-button bg-orange-500 text-white py-1 px-2 rounded text-xs" data-url="${studentUrl}">æ–°åˆ†é é–‹å•Ÿ</button>
                        </div>
                    `;
                    archiveListContainer.appendChild(itemEl);
                });

                document.querySelectorAll('.open-archive-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => loadArchive(e.target.dataset.id));
                });
                document.querySelectorAll('.delete-archive-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => deleteArchive(e.target.dataset.id));
                });
                
                // æ–°å¢çš„æŒ‰éˆ•äº‹ä»¶è™•ç†
                document.querySelectorAll('.copy-url-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        navigator.clipboard.writeText(e.target.dataset.url).then(() => {
                            showAlert('ç¶²å€å·²è¤‡è£½ï¼');
                        });
                    });
                });
                
                document.querySelectorAll('.copy-student-url-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        navigator.clipboard.writeText(e.target.dataset.url).then(() => {
                            showAlert('å­¸ç”Ÿæ¨¡å¼ç¶²å€å·²è¤‡è£½ï¼');
                        });
                    });
                });
                
                document.querySelectorAll('.open-new-tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        window.open(e.target.dataset.url, '_blank');
                    });
                });
                
                // ä»£ç¢¼ç·¨è¼¯åŠŸèƒ½
                document.querySelectorAll('.data-code-input').forEach(input => {
                    input.addEventListener('blur', async (e) => {
                        const newCode = e.target.value.trim().toUpperCase();
                        const originalCode = e.target.dataset.original;
                        const archiveId = e.target.dataset.id;
                        
                        if (newCode !== originalCode && newCode.length === 4) {
                            try {
                                // æª¢æŸ¥æ–°ä»£ç¢¼æ˜¯å¦å·²å­˜åœ¨
                                if (await isCodeExists(newCode)) {
                                    showAlert('æ­¤ä»£ç¢¼å·²è¢«ä½¿ç”¨ï¼Œè«‹é¸æ“‡å…¶ä»–ä»£ç¢¼ï¼', 'éŒ¯èª¤');
                                    e.target.value = originalCode;
                                    return;
                                }
                                
                                // æ›´æ–°è³‡æ–™åº«
                                await updateDoc(doc(db, "archives", archiveId), {
                                    dataCode: newCode
                                });
                                
                                e.target.dataset.original = newCode;
                                showAlert('ä»£ç¢¼å·²æ›´æ–°ï¼');
                            } catch (error) {
                                console.error("æ›´æ–°ä»£ç¢¼å¤±æ•—:", error);
                                showAlert('æ›´æ–°ä»£ç¢¼å¤±æ•—ï¼', 'éŒ¯èª¤');
                                e.target.value = originalCode;
                            }
                        } else if (newCode.length !== 4) {
                            showAlert('ä»£ç¢¼å¿…é ˆç‚º4ä½è‹±æ•¸å­—ï¼', 'éŒ¯èª¤');
                            e.target.value = originalCode;
                        }
                    });
                    
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.target.blur();
                        }
                    });
                });
            });
        };

        const loadArchive = (archiveId) => {
            openModalEl.classList.add('hidden');
            if (unsubscribeArchives) {
                unsubscribeArchives();
                unsubscribeArchives = null;
            }
            showConfirm('é–‹å•ŸèˆŠæª”å°‡æœƒè¦†è“‹ç›®å‰æ‰€æœ‰çš„å™—æ–‡ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ', async () => {
                showSyncStatus(true, false, 'è®€å–å­˜æª”ä¸­...');
                try {
                    // 1. æ¸…ç©ºç›®å‰çš„ sections
                    const sectionsSnapshot = await getDocs(collection(db, "sections"));
                    const deleteBatch = writeBatch(db);
                    for (const sectionDoc of sectionsSnapshot.docs) {
                        const postsSnapshot = await getDocs(collection(db, `sections/${sectionDoc.id}/posts`));
                        postsSnapshot.forEach(postDoc => deleteBatch.delete(postDoc.ref));
                        deleteBatch.delete(sectionDoc.ref);
                    }
                    await deleteBatch.commit();

                    // 2. è®€å–å­˜æª”è³‡æ–™
                    const archiveDoc = await getDoc(doc(db, "archives", archiveId));
                    if (!archiveDoc.exists()) {
                        throw new Error("æ‰¾ä¸åˆ°è©²å­˜æª”ï¼");
                    }
                    const archiveData = archiveDoc.data();

                    // 3. å¯«å…¥æ–°è³‡æ–™
                    const addBatch = writeBatch(db);
                    // å¯«å…¥è¨­å®š
                    const settingsRef = doc(db, "settings", "config");
                    addBatch.set(settingsRef, {
                        mainTitle: archiveData.title,
                        backgroundUrl: archiveData.backgroundUrl
                    });

                    // å¯«å…¥å™—æ–‡å’Œå›æ‡‰
                    for (const section of archiveData.sections) {
                        // è™•ç†å¯èƒ½ç¼ºå°‘çš„æ¬„ä½ï¼Œé¿å…å¯«å…¥ undefined
                        const sectionData = {
                            title: section.title,
                            createdAt: new Date(section.createdAt),
                            type: section.type || 'text', // é è¨­ç‚º 'text'
                            imageUrl: section.imageUrl || null
                        };
                        const sectionRef = doc(collection(db, "sections"));
                        addBatch.set(sectionRef, sectionData);

                        if (section.posts && section.posts.length > 0) {
                            for (const post of section.posts) {
                                // è™•ç†å¯èƒ½ç¼ºå°‘çš„æ¬„ä½
                                const postData = {
                                    ...post,
                                    createdAt: new Date(post.createdAt),
                                    type: post.type || 'text', // é è¨­ç‚º 'text'
                                    url: post.url || null
                                };
                                const postRef = doc(collection(db, `sections/${sectionRef.id}/posts`));
                                addBatch.set(postRef, postData);
                            }
                        }
                    }
                    await addBatch.commit();
                    
                    showSyncStatus(false, false, 'è®€å–æˆåŠŸï¼');
                } catch (error) {
                    console.error("è®€å–å­˜æª”å¤±æ•—:", error);
                    showAlert(`è®€å–å­˜æª”å¤±æ•—ï¼\n${error.message}`, "éŒ¯èª¤");
                    showSyncStatus(false, true);
                }
            });
        };

        const deleteArchive = (archiveId) => {
            openModalEl.classList.add('hidden');
            if (unsubscribeArchives) {
                unsubscribeArchives();
                unsubscribeArchives = null;
            }
            showConfirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™å€‹å­˜æª”å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚', async () => {
                showSyncStatus(true, false, 'åˆªé™¤å­˜æª”ä¸­...');
                try {
                    await deleteDoc(doc(db, "archives", archiveId));
                    showSyncStatus(false, false, 'åˆªé™¤æˆåŠŸï¼');
                } catch (error) {
                    console.error("åˆªé™¤å­˜æª”å¤±æ•—:", error);
                    showAlert(`åˆªé™¤å­˜æª”å¤±æ•—ï¼\n${error.message}`, "éŒ¯èª¤");
                    showSyncStatus(false, true);
                }
            });
        };

        // --- åŒ¯å‡ºèˆ‡åŒ¯å…¥åŠŸèƒ½ ---

        const exportData = async () => {
            if (!checkFirebase()) return;
            const title = mainTitleInput.value.trim() || 'Plurkå›æ‡‰ç‰†';
            
            try {
                const settingsDoc = await getDoc(doc(db, "settings", "config"));
                const backgroundUrl = (settingsDoc.exists() && settingsDoc.data().backgroundUrl) ? settingsDoc.data().backgroundUrl : '';

                const serializableSections = sections.map(section => ({
                    ...section,
                    createdAt: section.createdAt?.toDate().toISOString() || new Date().toISOString(),
                    posts: section.posts.map(post => ({
                        ...post,
                        createdAt: post.createdAt?.toDate().toISOString() || new Date().toISOString(),
                    }))
                }));

                const exportData = {
                    title: title,
                    backgroundUrl: backgroundUrl,
                    exportedAt: new Date().toISOString(),
                    sections: serializableSections
                };

                const jsonStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${title}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAlert(`è³‡æ–™å·²æˆåŠŸåŒ¯å‡ºç‚ºã€Œ${title}.jsonã€`, 'åŒ¯å‡ºæˆåŠŸ');
            } catch (error) {
                console.error("åŒ¯å‡ºå¤±æ•—:", error);
                showAlert(`åŒ¯å‡ºå¤±æ•—ï¼\n${error.message}`, "éŒ¯èª¤");
            }
        };

        // ä¸‹è¼‰HTMLå ±å‘ŠåŠŸèƒ½
        const downloadHtml = () => {
            const title = mainTitleInput.value.trim() || 'Plurkå›æ‡‰ç‰†';
            const timestamp = new Date().toLocaleString('zh-TW');
            
            // å‰µå»ºHTMLå…§å®¹
            let htmlContent = `
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title} - å›æ‡‰å ±å‘Š</title>
    <style>
        body {
            font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
        }
        .header .timestamp {
            font-size: 1.1em;
            opacity: 0.9;
        }
        .post-section {
            background: white;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .post-header {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            padding: 20px;
            border-bottom: 3px solid #fdcb6e;
        }
        .post-title {
            font-size: 1.8em;
            font-weight: bold;
            color: #2d3436;
            margin: 0;
            word-wrap: break-word;
        }
        .post-image {
            max-width: 300px;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .responses-table {
            width: 100%;
            border-collapse: collapse;
        }
        .responses-table th {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: bold;
            font-size: 1.1em;
        }
        .responses-table td {
            padding: 15px 10px;
            border-bottom: 1px solid #ddd;
            vertical-align: top;
            word-wrap: break-word;
        }
        .responses-table tr:nth-child(even) {
            background-color: #f8f9ff;
        }
        .responses-table tr:hover {
            background-color: #e8f4f8;
        }
        .response-name {
            font-weight: bold;
            color: #2d3436;
            font-size: 1.1em;
        }
        .response-content {
            line-height: 1.6;
            white-space: pre-wrap;
            color: #636e72;
        }
        .response-media img {
            max-width: 200px;
            height: auto;
            border-radius: 5px;
            margin-top: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .response-media iframe {
            width: 280px;
            height: 158px;
            border: none;
            border-radius: 5px;
            margin-top: 5px;
        }
        .response-media a {
            color: #0984e3;
            text-decoration: none;
            padding: 5px 10px;
            background: #e8f4f8;
            border-radius: 5px;
            display: inline-block;
            margin-top: 5px;
            word-break: break-all;
        }
        .response-media a:hover {
            background: #d1ecf1;
        }
        .no-responses {
            text-align: center;
            padding: 40px;
            color: #636e72;
            font-style: italic;
            background: #f8f9fa;
        }
        .stats {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stats h3 {
            margin-top: 0;
            color: #2d3436;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .stat-item {
            background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        /* --- MODIFICATION START: åœ–ç‰‡æ”¾å¤§æª¢è¦–å™¨æ¨£å¼ --- */
        .image-modal {
            display: none; /* é è¨­éš±è— */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.85);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content-image {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 8px;
            animation: zoomIn 0.3s;
        }
        @keyframes zoomIn {
            from { transform: translate(-50%, -50%) scale(0.5); }
            to { transform: translate(-50%, -50%) scale(1); }
        }
        .close-modal {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        .close-modal:hover,
        .close-modal:focus {
            color: #bbb;
            text-decoration: none;
        }
        .zoomable-image {
            cursor: zoom-in;
            transition: transform 0.2s ease-in-out;
        }
        .zoomable-image:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        /* --- MODIFICATION END --- */
    /* --- MODIFICATION END --- */
    </style>
</head>
<body>
    <div style="position: fixed; bottom: 10px; right: 10px; background-color: rgba(0, 0, 0, 0.7); color: white; padding: 8px 12px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); font-size: 14px; font-family: 'Noto Sans TC', sans-serif; z-index: 1001;">
        Made by <strong>é˜¿å‰›è€å¸«</strong>
    </div>
    <div class="header">
        <h1>${title}</h1>
        <div class="timestamp">åŒ¯å‡ºæ™‚é–“ï¼š${timestamp}</div>
    </div>
`;
`;
`;

            // çµ±è¨ˆè³‡æ–™
            const totalPosts = sections.length;
            let totalResponses = 0;
            sections.forEach(section => {
                if (section.posts) {
                    totalResponses += section.posts.length;
                }
            });

            htmlContent += `
    <div class="stats">
        <h3>ğŸ“Š çµ±è¨ˆè³‡æ–™</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <span class="stat-number">${totalPosts}</span>
                <span class="stat-label">ç¸½å™—æ–‡æ•¸</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">${totalResponses}</span>
                <span class="stat-label">ç¸½å›æ‡‰æ•¸</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">${totalPosts > 0 ? (totalResponses / totalPosts).toFixed(1) : 0}</span>
                <span class="stat-label">å¹³å‡å›æ‡‰æ•¸</span>
            </div>
        </div>
    </div>
`;

            // éæ­·æ¯å€‹å™—æ–‡
            sections.forEach((section, sectionIndex) => {
                htmlContent += `
    <div class="post-section">
        <div class="post-header">
            <div class="post-title">${section.title || `å™—æ–‡ ${sectionIndex + 1}`}</div>`;

                // å¦‚æœæœ‰åœ–ç‰‡ï¼ŒåŠ å…¥åœ–ç‰‡
                if (section.imageUrl) {
                    // --- MODIFICATION: åŠ å…¥ zoomable-image class ---
                    htmlContent += `
            <img src="${section.imageUrl}" alt="å™—æ–‡åœ–ç‰‡" class="post-image zoomable-image">`;
                }

                htmlContent += `
        </div>`;

                // å›æ‡‰è¡¨æ ¼
                if (section.posts && section.posts.length > 0) {
                    htmlContent += `
        <table class="responses-table">
            <thead>
                <tr>
                    <th style="width: 15%;">å›æ‡‰è€…</th>
                    <th style="width: 45%;">å…§å®¹</th>
                    <th style="width: 40%;">åª’é«”/é€£çµ</th>
                </tr>
            </thead>
            <tbody>`;

                    section.posts.forEach(post => {
                        let mediaHtml = '';
                        
                        // è™•ç†ä¸åŒé¡å‹çš„åª’é«”
                        switch (post.type) {
                            case 'image_url':
                            case 'image_upload':
                            case 'drawing':
                                // --- MODIFICATION: åŠ å…¥ zoomable-image class ---
                                mediaHtml = `<div class="response-media"><img src="${post.url}" alt="å›æ‡‰åœ–ç‰‡" class="zoomable-image"></div>`;
                                break;
                            case 'youtube':
                                const embedUrl = getYoutubeEmbedUrl(post.url);
                                if (embedUrl) {
                                    mediaHtml = `<div class="response-media"><iframe src="${embedUrl}" allowfullscreen></iframe></div>`;
                                }
                                break;
                            case 'link':
                                mediaHtml = `<div class="response-media"><a href="${post.url}" target="_blank">${post.url}</a></div>`;
                                break;
                        }

                        htmlContent += `
                <tr>
                    <td><div class="response-name">${post.title || 'åŒ¿å'}</div></td>
                    <td><div class="response-content">${post.content || ''}</div></td>
                    <td>${mediaHtml}</td>
                </tr>`;
                    });

                    htmlContent += `
            </tbody>
        </table>`;
                } else {
                    htmlContent += `
        <div class="no-responses">ç›®å‰æ²’æœ‰å›æ‡‰</div>`;
                }

                htmlContent += `
    </div>`;
            });

            // --- MODIFICATION START: åŠ å…¥ modal çš„ HTML å’Œ script ---
            htmlContent += `
    <!-- åœ–ç‰‡æ”¾å¤§æª¢è¦–å™¨ -->
    <div id="myModal" class="image-modal">
        <span class="close-modal">&times;</span>
        <img class="modal-content-image" id="img01">
    </div>

    <script>
        // å–å¾— modal
        var modal = document.getElementById('myModal');
        var modalImg = document.getElementById("img01");
        
        // å–å¾—æ‰€æœ‰å¯æ”¾å¤§çš„åœ–ç‰‡
        var images = document.querySelectorAll('.zoomable-image');
        images.forEach(function(img) {
            img.onclick = function(){
                modal.style.display = "block";
                modalImg.src = this.src;
            }
        });

        // å–å¾—é—œé–‰æŒ‰éˆ•
        var span = document.getElementsByClassName("close-modal")[0];

        // é»æ“Š <span> (x) é—œé–‰ modal
        if (span) {
            span.onclick = function() { 
                modal.style.display = "none";
            }
        }
        
        // é»æ“Š modal èƒŒæ™¯é—œé–‰
        modal.onclick = function(event) {
            // ç¢ºä¿é»æ“Šçš„æ˜¯èƒŒæ™¯è€Œä¸æ˜¯åœ–ç‰‡æœ¬èº«
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    <\/script>
`;
            // --- MODIFICATION END ---

            htmlContent += `
</body>
</html>`;

            // ä¸‹è¼‰HTMLæª”æ¡ˆ
            const blob = new Blob([htmlContent], { type: 'text/html; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title}_å›æ‡‰å ±å‘Š_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert(`HTMLå ±å‘Šå·²æˆåŠŸä¸‹è¼‰ç‚ºã€Œ${title}_å›æ‡‰å ±å‘Š_${new Date().toISOString().split('T')[0]}.htmlã€`, 'ä¸‹è¼‰æˆåŠŸ');
        };

        const handleFileImport = (file) => {
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                showAlert('è«‹é¸æ“‡ JSON æ ¼å¼çš„æª”æ¡ˆï¼');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // é©—è­‰è³‡æ–™æ ¼å¼
                    if (!data.title || !Array.isArray(data.sections)) {
                        throw new Error('æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼ç¼ºå°‘å¿…è¦çš„ title æˆ– sections æ¬„ä½ã€‚');
                    }

                    importData = data;
                    importModal.classList.add('hidden');
                    showConfirm(`å³å°‡åŒ¯å…¥ã€Œ${data.title}ã€çš„è³‡æ–™ï¼ŒåŒ…å« ${data.sections.length} å‰‡å™—æ–‡ã€‚é€™å°‡è¦†è“‹ç›®å‰æ‰€æœ‰çš„å™—æ–‡å’Œè¨­å®šï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`, executeImport);
                } catch (error) {
                    console.error("è§£ææª”æ¡ˆå¤±æ•—:", error);
                    showAlert(`ç„¡æ³•è§£ææª”æ¡ˆï¼è«‹ç¢ºèªé€™æ˜¯ä¸€å€‹æœ‰æ•ˆçš„ JSON æª”æ¡ˆã€‚\néŒ¯èª¤ï¼š${error.message}`, "æª”æ¡ˆæ ¼å¼éŒ¯èª¤");
                }
            };
            reader.readAsText(file);
        };

        const executeImport = async () => {
            if (!importData || !checkFirebase()) {
                showAlert('æ²’æœ‰å¯åŒ¯å…¥çš„è³‡æ–™ï¼Œè«‹å…ˆé¸æ“‡æª”æ¡ˆï¼');
                return;
            }
            
            // å…ˆä¿å­˜ importData çš„å‰¯æœ¬ï¼Œé¿å…åœ¨åŸ·è¡Œéç¨‹ä¸­è¢«æ¸…ç©º
            const dataToImport = JSON.parse(JSON.stringify(importData));
            
            // é¡å¤–æª¢æŸ¥è³‡æ–™å®Œæ•´æ€§
            if (!dataToImport.title || !Array.isArray(dataToImport.sections)) {
                showAlert('åŒ¯å…¥è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºï¼', 'éŒ¯èª¤');
                return;
            }
            
            showSyncStatus(true, false, 'åŒ¯å…¥è³‡æ–™ä¸­...');
            try {
                    // 1. æ¸…ç©ºç›®å‰çš„ sections
                    const sectionsSnapshot = await getDocs(collection(db, "sections"));
                    const deleteBatch = writeBatch(db);
                    for (const sectionDoc of sectionsSnapshot.docs) {
                        const postsSnapshot = await getDocs(collection(db, `sections/${sectionDoc.id}/posts`));
                        postsSnapshot.forEach(postDoc => deleteBatch.delete(postDoc.ref));
                        deleteBatch.delete(sectionDoc.ref);
                    }
                    await deleteBatch.commit();

                    // 2. åŒ¯å…¥æ–°è³‡æ–™
                    const addBatch = writeBatch(db);
                    
                    // æ›´æ–°è¨­å®š
                    const settingsRef = doc(db, "settings", "config");
                    addBatch.set(settingsRef, {
                        mainTitle: dataToImport.title,
                        backgroundUrl: dataToImport.backgroundUrl || ''
                    });

                    // åŒ¯å…¥å™—æ–‡å’Œå›æ‡‰
                    for (const section of dataToImport.sections) {
                        const sectionRef = doc(collection(db, "sections"));
                        // ä¿®å¾©: ç¢ºä¿ section.type å’Œ section.imageUrl æœ‰é è¨­å€¼
                        const sectionData = {
                            title: section.title,
                            createdAt: new Date(section.createdAt),
                            type: section.type || 'text',
                            imageUrl: section.imageUrl || null
                        };
                        addBatch.set(sectionRef, sectionData);

                        if (section.posts && section.posts.length > 0) {
                            for (const post of section.posts) {
                                const postRef = doc(collection(db, `sections/${sectionRef.id}/posts`));
                                // ä¿®å¾©: ç¢ºä¿ post.type å’Œ post.url æœ‰é è¨­å€¼
                                const postData = {
                                    ...post,
                                    createdAt: new Date(post.createdAt),
                                    type: post.type || 'text',
                                    url: post.url || null
                                };
                                addBatch.set(postRef, postData);
                            }
                        }
                    }
                    
                    await addBatch.commit();
                
                showSyncStatus(false, false, 'åŒ¯å…¥æˆåŠŸï¼');
                importData = null;
                showAlert('è³‡æ–™åŒ¯å…¥å®Œæˆï¼');
            } catch (error) {
                console.error("åŒ¯å…¥å¤±æ•—:", error);
                showAlert(`åŒ¯å…¥å¤±æ•—ï¼\n${error.message}`, "éŒ¯èª¤");
                showSyncStatus(false, true);
            }
        };
        
        // å…¶ä»–è¼”åŠ©å‡½å¼
        const handleTypeChange = (e) => {
            const type = e.target.value;
            const urlContainer = document.getElementById('url-input-container');
            const uploadContainer = document.getElementById('upload-container');
            const urlLabel = document.getElementById('url-label');
            urlContainer.classList.add('hidden');
            uploadContainer.classList.add('hidden');
            switch (type) {
                case 'image_url': urlContainer.classList.remove('hidden'); urlLabel.textContent = 'åœ–ç‰‡ç¶²å€'; break;
                case 'youtube': urlContainer.classList.remove('hidden'); urlLabel.textContent = 'YouTube ç¶²å€'; break;
                case 'link': urlContainer.classList.remove('hidden'); urlLabel.textContent = 'ç¶²å€'; break;
                case 'image_upload': uploadContainer.classList.remove('hidden'); break;
                case 'drawing': break;
            }
            // å‘¼å«å¡—é´‰è™•ç†å‡½æ•¸
            handleDrawingTypeChange(e);
        };

        const handleImageUpload = (file, type) => {
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                showAlert('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ'); return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = type === 'background' ? 1920 : 800;
                    const scale = Math.min(1, maxWidth / img.width);
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.85);

                    if (dataUrl.length > 900000) { 
                        showAlert('è­¦å‘Šï¼šåœ–ç‰‡æª”æ¡ˆéå¤§ï¼Œå³ä½¿å£“ç¸®å¾Œä»å¯èƒ½è¶…éè³‡æ–™åº«é™åˆ¶ï¼Œå»ºè­°æ‚¨é¸å–æ›´å°çš„åœ–ç‰‡ï¼Œå¦å‰‡å¯èƒ½å„²å­˜å¤±æ•—ã€‚', 'æª”æ¡ˆéå¤§');
                    }

                    if (type === 'background') {
                        uploadedBgImageData = dataUrl;
                        document.getElementById('bg-upload-filename').textContent = `å·²é¸æ“‡: ${file.name}`;
                    } else if (type === 'response') {
                        uploadedImageData = dataUrl;
                        document.getElementById('upload-filename').textContent = `å·²é¸æ“‡: ${file.name}`;
                    } else if (type === 'new-plurk') {
                        newPlurkUploadedImage = dataUrl;
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };
        
        const handleDragEvents = (e) => {
            e.preventDefault(); e.stopPropagation();
            if (e.type === 'dragenter' || e.type === 'dragover') {
                e.currentTarget.classList.add('bg-gray-100');
            } else if (e.type === 'dragleave') {
                e.currentTarget.classList.remove('bg-gray-100');
            }
        };

        const handleImageDrop = (e) => {
            e.preventDefault();
            e.currentTarget.classList.remove('bg-gray-100');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleImageUpload(files[0], 'response');
            }
        };

        const autoResizeTextarea = (e) => {
            const textarea = e.target;
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        };

        const getYoutubeEmbedUrl = (url) => {
            if (!url) return '';
            const regExp = /^.*(youtu.be\/|v\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            if (match && match[2].length === 11) {
                return `https://www.youtube.com/embed/${match[2]}`;
            }
            return '';
        };

        const restoreDefaultBackground = async () => {
            if (!checkFirebase()) return;

            settingBgModal.classList.add('hidden');
            uploadedBgImageData = null;
            document.getElementById('bg-upload-filename').textContent = '';
            
            showConfirm('ç¢ºå®šè¦å°‡æ²³é“èƒŒæ™¯æ¢å¾©ç‚ºé è¨­åœ–ç‰‡å—ï¼Ÿ', async () => {
                showSyncStatus(true, false, 'æ¢å¾©é è¨­èƒŒæ™¯ä¸­...');
                try {
                    const defaultBgUrl = 'https://images.plurk.com/6rYRzJbEIqWyR8wei5we.jpg';
                    await setDoc(doc(db, "settings", "config"), { backgroundUrl: defaultBgUrl }, { merge: true });
                    showSyncStatus(false, false, 'èƒŒæ™¯å·²æ¢å¾©ï¼');
                } catch (error) {
                    console.error("æ¢å¾©é è¨­èƒŒæ™¯å¤±æ•—:", error);
                    showAlert(`æ¢å¾©é è¨­èƒŒæ™¯å¤±æ•—ï¼\n${error.message}`, "éŒ¯èª¤");
                    showSyncStatus(false, true);
                }
            });
        };

        // è¨­ç½®å¡—é´‰ç›¸é—œäº‹ä»¶ç›£è½
        const setupDrawingEventListeners = () => {
            closeDrawingBtn.addEventListener('click', () => closeDrawingModal(true));
            drawingModal.addEventListener('click', (e) => {
                if (e.target === drawingModal) closeDrawingModal(true);
            });
            
            brushTool.addEventListener('click', () => setTool('brush'));
            eraserTool.addEventListener('click', () => setTool('eraser'));
            
            brushSize.addEventListener('input', (e) => {
                currentBrushSize = e.target.value;
                brushSizeDisplay.textContent = currentBrushSize;
            });
            
            colorBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    currentColor = btn.dataset.color;
                    colorBtns.forEach(b => b.classList.remove('ring-4', 'ring-blue-500'));
                    btn.classList.add('ring-4', 'ring-blue-500');
                });
            });
            
            uploadBgBtn.addEventListener('click', () => drawingBgUpload.click());
            drawingBgUpload.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    loadDrawingBackground(e.target.files[0]);
                }
            });
            
            clearCanvasBtn.addEventListener('click', clearDrawingCanvas);
            saveDrawingBtn.addEventListener('click', saveDrawing);
            
            // è¨­ç½®ç•«å¸ƒäº‹ä»¶
            setupCanvasEvents();
            
            // é è¨­é¸æ“‡é»‘è‰²
            document.querySelector('.color-btn[data-color="#000000"]').click();
        };
        
        // è¨­ç½®ç•«å¸ƒäº‹ä»¶
        const setupCanvasEvents = () => {
            // æ»‘é¼ äº‹ä»¶
            drawingCanvas.addEventListener('mousedown', startDrawing);
            drawingCanvas.addEventListener('mousemove', draw);
            drawingCanvas.addEventListener('mouseup', stopDrawing);
            drawingCanvas.addEventListener('mouseout', stopDrawing);
            
            // è§¸æ§äº‹ä»¶ (iPad æ”¯æ´)
            drawingCanvas.addEventListener('touchstart', handleTouch);
            drawingCanvas.addEventListener('touchmove', handleTouch);
            drawingCanvas.addEventListener('touchend', stopDrawing);
            drawingCanvas.addEventListener('touchcancel', stopDrawing);
        };
        
        // é–‹å•Ÿå¡—é´‰æ¨¡æ…‹æ¡†
        const openDrawingModal = () => {
            drawingModal.classList.remove('hidden');
            
            // é‡ç½®æŒ‰éˆ•æ–‡å­—
            const drawingBtn = document.querySelector('.drawing-open-btn');
            if (drawingBtn && drawingBtn.textContent.includes('(å·²å„²å­˜)')) {
                drawingBtn.textContent = 'é–‹å•Ÿå¡—é´‰ç•«æ¿';
            }
            
            // ç­‰å¾… DOM æ›´æ–°å¾Œåˆå§‹åŒ– canvas
            setTimeout(() => {
                initDrawingCanvas();
                loadOriginalPostImages();
            }, 100);
        };
        
        // é—œé–‰å¡—é´‰æ¨¡æ…‹æ¡†
        const closeDrawingModal = (clearData = false) => {
            drawingModal.classList.add('hidden');
            if (clearData) {
                drawingData = null;
            }
        };
        
        // åˆå§‹åŒ–ç•«å¸ƒ
        const initDrawingCanvas = () => {
            const container = drawingCanvas.parentElement;
            const rect = container.getBoundingClientRect();
            
            // è¨­ç½® canvas å¤§å°
            drawingCanvas.width = rect.width;
            drawingCanvas.height = rect.height;
            drawingBgCanvas.width = rect.width;
            drawingBgCanvas.height = rect.height;
            
            drawingCtx = drawingCanvas.getContext('2d');
            drawingBgCtx = drawingBgCanvas.getContext('2d');
            
            // è¨­ç½®ç¹ªåœ–å±¬æ€§
            drawingCtx.lineCap = 'round';
            drawingCtx.lineJoin = 'round';
            
            // å°‡èƒŒæ™¯ç•«å¸ƒé è¨­ç‚ºç™½è‰²
            drawingBgCtx.fillStyle = '#FFFFFF';
            drawingBgCtx.fillRect(0, 0, drawingBgCanvas.width, drawingBgCanvas.height);
        };
        
        // åŠ è¼‰åŸå§‹å™—æ–‡åœ–ç‰‡ä½œç‚ºèƒŒæ™¯
        const loadOriginalPostImages = () => {
            if (originalPostImages.length > 0) {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    drawingBgCtx.clearRect(0, 0, drawingBgCanvas.width, drawingBgCanvas.height);
                    
                    // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹ä»¥é©æ‡‰ canvas
                    const scale = Math.min(
                        drawingBgCanvas.width / img.width,
                        drawingBgCanvas.height / img.height
                    );
                    const newWidth = img.width * scale;
                    const newHeight = img.height * scale;
                    const x = (drawingBgCanvas.width - newWidth) / 2;
                    const y = (drawingBgCanvas.height - newHeight) / 2;
                    
                    drawingBgCtx.drawImage(img, x, y, newWidth, newHeight);
                };
                img.src = originalPostImages[0]; // ä½¿ç”¨ç¬¬ä¸€å¼µåœ–ç‰‡
            }
        };
        
        // åŠ è¼‰è‡ªå®šç¾©èƒŒæ™¯åœ–ç‰‡
        const loadDrawingBackground = (file) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    drawingBgCtx.clearRect(0, 0, drawingBgCanvas.width, drawingBgCanvas.height);
                    
                    const scale = Math.min(
                        drawingBgCanvas.width / img.width,
                        drawingBgCanvas.height / img.height
                    );
                    const newWidth = img.width * scale;
                    const newHeight = img.height * scale;
                    const x = (drawingBgCanvas.width - newWidth) / 2;
                    const y = (drawingBgCanvas.height - newHeight) / 2;
                    
                    drawingBgCtx.drawImage(img, x, y, newWidth, newHeight);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };
        
        // è¨­ç½®å·¥å…·
        const setTool = (tool) => {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-500');
            });
            
            if (tool === 'brush') {
                brushTool.classList.remove('bg-gray-500');
                brushTool.classList.add('bg-blue-500', 'text-white');
                drawingCanvas.style.cursor = 'crosshair';
            } else if (tool === 'eraser') {
                eraserTool.classList.remove('bg-gray-500');
                eraserTool.classList.add('bg-blue-500', 'text-white');
                drawingCanvas.style.cursor = 'grab';
            }
        };
        
        // é–‹å§‹ç¹ªåœ–
        const startDrawing = (e) => {
            isDrawing = true;
            const rect = drawingCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            drawingCtx.beginPath();
            drawingCtx.moveTo(x, y);
        };
        
        // ç¹ªåœ–
        const draw = (e) => {
            if (!isDrawing) return;
            
            const rect = drawingCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            drawingCtx.lineWidth = currentBrushSize;
            
            if (currentTool === 'brush') {
                drawingCtx.globalCompositeOperation = 'source-over';
                drawingCtx.strokeStyle = currentColor;
            } else if (currentTool === 'eraser') {
                drawingCtx.globalCompositeOperation = 'destination-out';
            }
            
            drawingCtx.lineTo(x, y);
            drawingCtx.stroke();
        };
        
        // åœæ­¢ç¹ªåœ–
        const stopDrawing = () => {
            isDrawing = false;
            drawingCtx.beginPath();
        };
        
        // è™•ç†è§¸æ§äº‹ä»¶
        const handleTouch = (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            if (!touch) return;
            
            const rect = drawingCanvas.getBoundingClientRect();
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            
            drawingCanvas.dispatchEvent(mouseEvent);
        };
        
        // æ¸…ç©ºç•«å¸ƒ
        const clearDrawingCanvas = () => {
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        };
        
        // å„²å­˜å¡—é´‰
        const saveDrawing = () => {
            // å‰µå»ºä¸€å€‹æ–°çš„ canvas ä¾†åˆä½µèƒŒæ™¯å’Œç¹ªåœ–
            const mergedCanvas = document.createElement('canvas');
            mergedCanvas.width = drawingCanvas.width;
            mergedCanvas.height = drawingCanvas.height;
            const mergedCtx = mergedCanvas.getContext('2d');
            
            // æ–°å¢ï¼šå…ˆå°‡ç•«å¸ƒèƒŒæ™¯è¨­ç‚ºç™½è‰²
            mergedCtx.fillStyle = '#FFFFFF';
            mergedCtx.fillRect(0, 0, mergedCanvas.width, mergedCanvas.height);

            // å…ˆç¹ªèƒŒæ™¯
            mergedCtx.drawImage(drawingBgCanvas, 0, 0);
            // å†ç¹ªå¡—é´‰å…§å®¹
            mergedCtx.drawImage(drawingCanvas, 0, 0);
            
            // å£“ç¸®åœ–ç‰‡ä¸¦è½‰æ›ç‚º base64 (èˆ‡ä¸Šå‚³åœ–ç‰‡ç›¸åŒçš„å£“ç¸®é‚è¼¯)
            const maxWidth = 800;
            const scale = Math.min(1, maxWidth / mergedCanvas.width);
            
            // å‰µå»ºå£“ç¸®å¾Œçš„ canvas
            const compressedCanvas = document.createElement('canvas');
            compressedCanvas.width = mergedCanvas.width * scale;
            compressedCanvas.height = mergedCanvas.height * scale;
            const compressedCtx = compressedCanvas.getContext('2d');
            
            // ç¹ªè£½å£“ç¸®å¾Œçš„åœ–ç‰‡
            compressedCtx.drawImage(mergedCanvas, 0, 0, compressedCanvas.width, compressedCanvas.height);
            
            // è½‰æ›ç‚º base64 ä¸¦å£“ç¸®å“è³ª
            drawingData = compressedCanvas.toDataURL('image/jpeg', 0.85);
            
            // æª¢æŸ¥æª”æ¡ˆå¤§å°
            if (drawingData.length > 900000) { 
                showAlert('è­¦å‘Šï¼šå¡—é´‰æª”æ¡ˆéå¤§ï¼Œå³ä½¿å£“ç¸®å¾Œä»å¯èƒ½è¶…éè³‡æ–™åº«é™åˆ¶ï¼Œå¯èƒ½å„²å­˜å¤±æ•—ã€‚', 'æª”æ¡ˆéå¤§');
            }
            
            // æ›´æ–°æŒ‰éˆ•æ–‡å­—é¡¯ç¤ºå·²å„²å­˜ç‹€æ…‹
            const drawingBtn = document.querySelector('.drawing-open-btn');
            if (drawingBtn) {
                drawingBtn.textContent = 'é–‹å•Ÿå¡—é´‰ç•«æ¿ (å·²å„²å­˜)';
            }
            
            // é—œé–‰å¡—é´‰è¦–çª—ï¼Œä½†ä¸æ¸…ç©ºè³‡æ–™
            closeDrawingModal(false);
        };
        
        // é–‹å•Ÿå›æ‡‰å±•é–‹æ¨¡æ…‹æ¡†
        const openResponsesModal = (sectionEl) => {
            const responsesModal = document.getElementById('responses-modal');
            const responsesContainer = document.getElementById('responses-container');
            
            // æ¸…ç©ºå®¹å™¨
            responsesContainer.innerHTML = '';
            
            // å–å¾—åŸå§‹å™—æ–‡è³‡æ–™
            const originalTitle = sectionEl.querySelector('.section-title-input');
            const originalImage = sectionEl.querySelector('.section-image img');
            
            // å‰µå»ºåŸå§‹å™—æ–‡å€å¡Š
            const originalSection = document.createElement('div');
            originalSection.className = 'col-span-full bg-gradient-to-r from-orange-100 to-yellow-100 border border-orange-200 p-4 rounded-lg mb-4 shadow-sm';
            
            const titleHeader = document.createElement('h3');
            titleHeader.className = 'text-lg font-bold mb-2 text-orange-800';
            titleHeader.textContent = 'åŸå§‹å™—æ–‡';
            originalSection.appendChild(titleHeader);
            
            // è¤‡è£½åŸå§‹å™—æ–‡å…§å®¹
            if (originalTitle && originalTitle.value.trim()) {
                const contentDiv = document.createElement('div');
                contentDiv.className = 'text-gray-800 mb-2 preserve-lines font-medium';
                contentDiv.textContent = originalTitle.value;
                originalSection.appendChild(contentDiv);
            }
            
            // è¤‡è£½åŸå§‹å™—æ–‡åœ–ç‰‡
            if (originalImage) {
                const imgClone = originalImage.cloneNode(true);
                imgClone.className = 'max-w-full h-auto rounded-lg mt-2';
                originalSection.appendChild(imgClone);
            }
            
            responsesContainer.appendChild(originalSection);
            
            // å–å¾—æ‰€æœ‰å›æ‡‰ (post-card elements)
            const responses = sectionEl.querySelectorAll('.post-card');
            
            if (responses.length === 0) {
                const noResponsesMsg = document.createElement('div');
                noResponsesMsg.className = 'col-span-full text-center text-gray-500 py-8 bg-gray-50 rounded-lg border border-gray-200';
                noResponsesMsg.textContent = 'ç›®å‰æ²’æœ‰å›æ‡‰';
                responsesContainer.appendChild(noResponsesMsg);
            } else {
                // ç‚ºæ¯å€‹å›æ‡‰å‰µå»ºå¡ç‰‡
                responses.forEach((response, index) => {
                    const responseCard = document.createElement('div');
                    responseCard.className = 'bg-gradient-to-br from-white to-blue-50 border border-blue-200 rounded-lg p-4 shadow-sm hover:shadow-lg hover:from-blue-50 hover:to-blue-100 transition-all duration-200';
                    
                    // å–å¾—å›æ‡‰çš„å§“å (å¾ h3 å…ƒç´ )
                    const nameElement = response.querySelector('h3');
                    const name = nameElement ? nameElement.textContent : `å›æ‡‰è€… ${index + 1}`;
                    
                    // å›æ‡‰è€…å§“å
                    const nameHeader = document.createElement('div');
                    nameHeader.className = 'text-sm font-bold text-orange-700 mb-2 flex items-center';
                    
                    // å–å¾—é ­åƒå­—æ¯
                    const avatarElement = response.querySelector('.reply-avatar');
                    if (avatarElement) {
                        const avatarSpan = document.createElement('span');
                        avatarSpan.className = 'inline-flex items-center justify-center w-7 h-7 bg-gradient-to-r from-orange-500 to-pink-500 text-white rounded-full text-xs font-bold mr-2 shadow-sm';
                        avatarSpan.textContent = avatarElement.textContent;
                        nameHeader.appendChild(avatarSpan);
                    }
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = name;
                    nameHeader.appendChild(nameSpan);
                    responseCard.appendChild(nameHeader);
                    
                    // å›æ‡‰å…§å®¹
                    const contentElement = response.querySelector('.text-sm.text-gray-700.preserve-lines');
                    if (contentElement && contentElement.textContent.trim()) {
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'text-gray-800 mb-3 preserve-lines leading-relaxed';
                        contentDiv.textContent = contentElement.textContent;
                        responseCard.appendChild(contentDiv);
                    }
                    
                    // å›æ‡‰åª’é«” (åœ–ç‰‡ã€å½±ç‰‡ã€é€£çµ)
                    const mediaImage = response.querySelector('img.viewable-image');
                    const mediaIframe = response.querySelector('iframe');
                    const mediaLink = response.querySelector('a[target="_blank"]');
                    
                    if (mediaImage) {
                        const imgClone = mediaImage.cloneNode(true);
                        imgClone.className = 'max-w-full h-auto rounded-lg mt-2 cursor-pointer';
                        imgClone.addEventListener('click', () => {
                            imageViewer.querySelector('.image-content').src = imgClone.src;
                            imageViewer.classList.remove('hidden');
                        });
                        responseCard.appendChild(imgClone);
                    } else if (mediaIframe) {
                        const iframeContainer = document.createElement('div');
                        iframeContainer.className = 'mt-2 border border-orange-200 rounded-md overflow-hidden shadow-sm';
                        iframeContainer.style.width = '100%';
                        iframeContainer.style.height = '360px'; // 2å€é«˜åº¦ (åŸæœ¬ç´„180px)
                        const iframeClone = mediaIframe.cloneNode(true);
                        iframeClone.className = 'w-full h-full';
                        iframeContainer.appendChild(iframeClone);
                        responseCard.appendChild(iframeContainer);
                    } else if (mediaLink) {
                        const linkClone = mediaLink.cloneNode(true);
                        linkClone.className = 'block mt-2 p-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200 text-blue-700 hover:text-blue-800 hover:from-blue-100 hover:to-indigo-100 transition-all break-all text-sm font-medium shadow-sm';
                        responseCard.appendChild(linkClone);
                    }
                    
                    // è®šæ•¸é¡¯ç¤º
                    const likesElement = response.querySelector('.font-bold.text-sm.mr-1');
                    if (likesElement && likesElement.textContent !== '0') {
                        const likesDiv = document.createElement('div');
                        likesDiv.className = 'text-xs text-orange-600 mt-3 flex items-center bg-orange-50 px-2 py-1 rounded-full border border-orange-200 w-fit';
                        likesDiv.innerHTML = `â¤ï¸ ${likesElement.textContent} å€‹è®š`;
                        responseCard.appendChild(likesDiv);
                    }
                    
                    responsesContainer.appendChild(responseCard);
                });
            }
            
            // é¡¯ç¤ºæ¨¡æ…‹æ¡†
            responsesModal.classList.remove('hidden');
        };
        
        // é—œé–‰å›æ‡‰å±•é–‹æ¨¡æ…‹æ¡†
        const closeResponsesModal = () => {
            const responsesModal = document.getElementById('responses-modal');
            responsesModal.classList.add('hidden');
        };
        
        // æ“´å±•é¡å‹è®Šæ›´è™•ç†å™¨ä»¥æ”¯æ´å¡—é´‰
        const handleDrawingTypeChange = (e) => {
            if (e.target.value === 'drawing') {
                // é¡¯ç¤ºé–‹å•Ÿå¡—é´‰æŒ‰éˆ•
                const drawingBtn = document.createElement('button');
                drawingBtn.type = 'button';
                drawingBtn.textContent = 'é–‹å•Ÿå¡—é´‰ç•«æ¿';
                drawingBtn.className = 'theme-button bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded-lg mt-2 w-full';
                drawingBtn.addEventListener('click', openDrawingModal);
                
                const existingBtn = document.querySelector('.drawing-open-btn');
                if (existingBtn) existingBtn.remove();
                
                drawingBtn.classList.add('drawing-open-btn');
                e.target.closest('.mt-4').appendChild(drawingBtn);
            } else {
                const existingBtn = document.querySelector('.drawing-open-btn');
                if (existingBtn) existingBtn.remove();
            }
        };
        
        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        init();
    </script>
</body>
</html>
